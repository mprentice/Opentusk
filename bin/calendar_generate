#!/usr/bin/perl
use FindBin;
use lib "$FindBin::Bin/../lib";

use Getopt::Long;

my ($year,$month);
GetOptions( "year=s" => \$year,
	    "month=s" => \$month
	    );
if (!$year && !$month) {
	print "Usage: calendar_generate --year=<YYYY> --month=<Jan|Jul>\n";
	exit;
}

$calendar = `cal $year`;
$month_no = $month =~ /Jan/ ? 1 : 7;
if ($month_no == 1) {
	$calendar =~ s/.+(Jan.+30.+31).+?(Apr.+(31|30)).+Jul.+/$1\n$2\n/s;
	$calendar =~ s/(\d{1,2}.*?)(\ {3}|\n)/\!\!\!\!$1\~\~$2/g;
	$month_orig = $month_no;
	while ($calendar =~ /\!\!\!\!.+Apr.+/s) {
		$month_no = "0".$month_no if ($month_no =~ /^\d{1}$/);
		$calendar =~ s/\!\!\!\!(\d{1,2})/\<a href=\"\/hsdb45\/schedule\/\[\+\$group\+\]\/$year-$month_no-$1\"\>$1/;
		$month_no++;
		if ($month_orig + 3 == $month_no) {
			$month_no = $month_orig;
		}
	}
	$month_no = $month_orig = $month_orig + 3;
	while ($calendar =~ /\!\!\!\!/s) {
		$month_no = "0".$month_no if ($month_no =~ /^\d{1}$/);
		$calendar =~ s/\!\!\!\!(\d{1,2})/\<a href=\"\/hsdb45\/schedule\/\[\+\$group\+\]\/$year-$month_no-$1\"\>$1/;
		$month_no++;
		if ($month_orig + 3 == $month_no) {
			$month_no = $month_orig;
		}
	}
	$calendar =~ s/-(\d{1})\"/-0$1\"/g;
}
else {
	$calendar =~ s/.+(Jul.+(31|30)).+(Oct.+(31|30))/$1\n$3\n/s;
	$calendar =~ s/(\d{1,2}.*?)(\ {3}|\n)/\!\!\!\!$1\~\~$2/g;
	$month_orig = $month_no;
	while ($calendar =~ /\!\!\!\!.+Oct.+/s) {
		$month_no = "0".$month_no if ($month_no =~ /^\d{1}$/);
		$calendar =~ s/\!\!\!\!(\d{1,2})/\<a href=\"\/hsdb45\/schedule\/\[\+\$group\+\]\/$year-$month_no-$1\"\>$1/;
		$month_no++;
		if ($month_orig + 3 == $month_no) {
			$month_no = $month_orig;
		}
	}
	$month_no = $month_orig = $month_orig + 3;
	while ($calendar =~ /\!\!\!\!/s) {
		$month_no = "0".$month_no if ($month_no =~ /^\d{1}$/);
		$calendar =~ s/\!\!\!\!(\d{1,2})/\<a href=\"\/hsdb45\/schedule\/\[\+\$group\+\]\/$year-$month_no-$1\"\>$1/;
		$month_no++;
		if ($month_orig + 3 == $month_no) {
			$month_no = $month_orig;
		}
	}
	$calendar =~ s/-(\d{1})\"/-0$1\"/g;
}

$calendar =~ s/(.*)(Jan.+Mar)(.+)/$1<div class=\"center\">$2<\/div>$3/s;
$calendar =~ s/(.*)(Apr.+Jun)(.+)/$1<br><div class=\"center\">$2<\/div>$3/s;
$calendar =~ s/(.*)(Jul.+Sep)(.+)/$1<div class=\"center\">$2<\/div>$3/s;
$calendar =~ s/(.*)(Oct.+Dec)(.+)/$1<br><div class=\"center\">$2<\/div>$3/s;

$calendar =~ s/\~\~/<\/a>/g;
$calendar = "[- \$group = shift \@param -]\n".$calendar;
print "$calendar";




