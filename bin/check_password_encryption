#!/bin/perl
use strict;
use FindBin;
use lib "$FindBin::Bin/../lib";

use TUSK::Configuration::Password;
use TUSK::Constants;
use HSDB4::Constants;

my $missingEncryption = 0;

if($HSDB4::Constants::LDAP_PASSWORD && !TUSK::Configuration::Password::isEncrypted($HSDB4::Constants::LDAP_PASSWORD)) {
	reportNonEncrypted('HSDB4::Constants::LDAP_PASSWORD', $HSDB4::Constants::LDAP_PASSWORD);
}
foreach my $dbUser (keys %{$TUSK::Constants::DatabaseUsers}) {
	my %userHash = %{$TUSK::Constants::DatabaseUsers->{$dbUser}};
	foreach my $property (keys %userHash) {
		if($property =~ /password/i) {
			my $password = $userHash{$property};
			if($password  && !TUSK::Configuration::Password::isEncrypted($password)) {
				reportNonEncrypted("TUSK::Constants::DatabaseUsers{$dbUser}{$property}", $password);
			}
		}
	}
}

if($missingEncryption) {
	print "We strongly recommend using bin/encrypt_password to generate an encrypted password for the above mentioned passwords.\n";
} else {
	print "All known passwords are encrypted.\n";
}

sub reportNonEncrypted {
	my $label = shift;
	my $password = shift;

	print "$label ($password) is not encrypted. Please set it to ". TUSK::Configuration::Password::encrypt($password) ."\n";
	$missingEncryption = 1;
}
