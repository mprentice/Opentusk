#!/usr/bin/perl
use FindBin;
use lib "$FindBin::Bin/../lib";
use strict;
use File::stat;

my $deleteIfOlderThan = 60*60*2;
my $startingDir = "/data/temp";

sub walkDir;
walkDir($startingDir);


sub walkDir {
	my $tempdir = shift;
	unless(opendir(DIR, "$tempdir")) {
		warn ("Unable to open dir $tempdir : $!\n");
		return;
	}

	while(defined(my $filename = readdir(DIR))) {
		next if ($filename =~ /^\./);
		my $fullName = $tempdir . "/" .$filename;

		if( -d $fullName ) {
			walkDir($fullName);
			my $age = time - stat($fullName)->mtime;
			my @filesInDir = <$fullName/*>;
			my $countFilesInDir = scalar @filesInDir;
			if(($countFilesInDir == 0) &&  ($age > $deleteIfOlderThan)) {
				unless(rmdir($fullName)) {  warn("Unable to rmdir $fullName : $!\n");  }
			}
		} elsif( -f $fullName ) {
			my $age = time - stat($fullName)->mtime;
			if($age > $deleteIfOlderThan) {
				unless(unlink($fullName)) {  warn("Unable to unlink $fullName : $!\n");  }
			}
		} else {
			warn("Unknow file type for: $fullName\n");
		}
	}

	closedir(DIR);
}
