[! use HSDB4::Constants qw(:school);
   use HSDB45::Eval::MergedResults;
   use HSDB45::Eval::Authoring;
   use HSDB4::SQLRow::User;
   use Carp qw(cluck);
   use Apache::Constants qw(NOT_FOUND REDIRECT);
   use Apache::Cookie;
   use XML::Twig;
 !]
[-
    $embperldir=$req_rec->server_root_relative($ENV{EMBPERL_LIB});
    my @path = split(/\//, $req_rec->path_info());
    shift @path;
    $school = shift @path;
    unless (get_school_db($school)) {
	cluck "Merged evals can't find school db for $school";
	Execute({inputfile => "$embperldir/missingHandler.html"});
        $req_rec->status (NOT_FOUND);
        exit;
    }

    # Get the authenticated user
    unless ($username = $req_rec->connection->user) {
        %cookies = Apache::Cookie->new($req_rec)->parse;
	if (defined($cookies{'Ticket'})){
		%ticket = $cookies{'Ticket'}->value;
		$username = $ticket{'user'};
	} else {
	    $req_rec->header_out("Location" => "/login?msg=Please+log_in");
	    $req_rec->status(REDIRECT);
	    exit();
	}
    }

    # Make sure we have permission
    $user = HSDB4::SQLRow::User->new()->lookup_key($username);
    $blank_eval = HSDB45::Eval->new( _school => $school );
    my $admin_group = $blank_eval->admin_group();
    unless ($user->primary_key() && $admin_group->contains_user($user)) {
        $req_rec->header_out (Location => '/forbidden.html');
        $req_rec->status (REDIRECT);
        exit;
    }

    # Get the eval
    $eval = $blank_eval;

    my $eval_uri;
    my $eval_id = shift @path;
    $eval = HSDB45::Eval::MergedResults->new( _school => $school, _id => $eval_id);
    $eval_uri = sprintf("/merged_eval_edit/%s/%d", $school, $eval_id);
    
    if ($eval_id !=0 && (!defined($eval) || !$eval->primary_key())) {
	cluck "Merged Eval from URL not found $school $eval_id";
	Execute({inputfile => "$embperldir/missingHandler.html"});
        $req_rec->status (NOT_FOUND);
        exit;
    }

    %msgs = ();
    if ($fdat{save}) {
	($result,$msg) = $eval->edit_merged_eval( $school,\%fdat);
        $eval_uri = sprintf("/merged_eval_edit/%s/%d?msg=Save+successful", $school, $eval->primary_key());
	if (!$result) {
		$req_rec->header_out(Location => $eval_uri);
		$req_rec->status(REDIRECT);
		exit;
	} else {
		$eval->primary_eval_id($fdat{primary_eval});
		$eval->secondary_eval_ids($fdat{secondary_evals});
		$eval->title($fdat{title});

	}
     }

    $escmode = 0;
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});
-]

<html>
<head>
<title>[+ $TUSK::Constants::SiteAbbr +] Edit Merged Eval</title>
[-
    # Import the style sheet
    Execute ("$embperldir/hsdb4-style.css")
-]

</head>
<body>

[- head_graphics("Merged Eval Editing: " . ucfirst($school)) -]

[$ if($result) $]
<div class="error">
[+ $msg +]
</div>
[$ endif $]
<hr/>
[$ if($fdat{msg}) $]
<div class="error">
[+ $fdat{msg} +]
</div>
[$ endif $]

<a href="/hsdb45/eval/merged_admin/[+$school+]">Back to Merged Eval Scoreboard</a>
<form method="post">
<table border="0" cellspacing="0" cellpadding="2" class="wide">
<tr>
<td>
<b>Title</b>
</td>
<td>
<input name="title" value="[+ $eval->title(); +]" size="60" length="255" />
</td>
</tr>
<tr>
<td>
<b>Primary Eval</b>
</td>
<td>
<input name="primary_eval" value="[+ $eval->primary_eval_id +]" size="20" length="20"/> 
</td>
</tr>
<tr>
<td>
<b>Secondary Evals</b>
</td>
<td>
<textarea name="secondary_evals" rows="5" cols="60">[+ join(",",$eval->secondary_eval_ids()) +]</textarea>
</td>
</tr>
<tr>
<td colspan="2">
[$ if ($eval->secondary_eval_ids()) $]
	<b>Titles of Secondary Evals</b>
	<ul>
	[$ foreach $sec_eval ($eval->secondary_eval_ids()) $]
	[- $this_eval = HSDB45::Eval->new(_school=>$school, _id=>$sec_eval); -]
		[$if (defined($this_eval->primary_key())) $]
			<li>[+ $this_eval->title() +]
		[$ endif $] 
	[$ endforeach $]
	</ul>
[$ endif $]
</td>
</tr>
<tr bgcolor="#ccccff">
<td align="center"><input type="submit" name="save" value="Save Changes" /></td>
<td></td>
<td></td>
<td align="center">
<input type="button" name="return_to_eval" 
onclick="window.location='/hsdb45/eval/merged_admin/[+ $school +]'" 
value="Return without Saving" /></td>
</tr>
</table>
</form>

<hr/>
[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html")) -]
</body>
</html>

