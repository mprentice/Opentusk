[! use HSDB4::Constants qw(:school);
   use HSDB45::Eval;
   use HSDB45::Eval::Authoring;
   use HSDB4::SQLRow::User;
   use TUSK::Core::HSDB45Tables::Course;
   use Apache::Constants qw(:response);
   use Apache::Cookie;
   use TUSK::FTS::Eval::Index;
!]
[-
	use strict;
    my @path = split(/\//, $req_rec->path_info());
    our $school = $path[1];
    unless (get_school_db($school)) {
        $req_rec->status (NOT_FOUND);
        Apache::exit();
    }

    # Get the authenticated user
    my $username = '';
    unless ($username = $req_rec->connection->user) {
        my %cookies = Apache::Cookie->new($req_rec)->parse;
        my %ticket = $cookies{'Ticket'} && $cookies{'Ticket'}->value;
	if (%ticket) { 
            $username = $ticket{'user'};
        }
	unless ($username) {
	    $req_rec->status(REDIRECT);
	    $req_rec->header_out(Location => "/guestlogin.html");
	    Apache::exit();
        }
    }

    # Make sure we have permission
    our $user = HSDB4::SQLRow::User->new()->lookup_key($username);
    our $blank_eval = HSDB45::Eval->new( _school => $school );
    my $admin_group = $blank_eval->admin_group();
    unless ($user->primary_key() && $admin_group->contains_user($user)) {
        $req_rec->status(REDIRECT);
        $req_rec->header_out(Location => "/forbidden.html");
        Apache::exit();
    }

    our ($res, $msg) = (1, '');
    # If we're trying to create a new one...
    if ($fdat{new_eval}) {
	($res, $msg) = HSDB45::Eval::Authoring::check_field_values(\%fdat);
        if ($res) {
            my $new_eval = HSDB45::Eval->new( _school => $school );
            $new_eval->set_field_values(title => $fdat{title},		
		course_id => $fdat{course_id},
		time_period_id => $fdat{time_period_id},
 		teaching_site_id => $fdat{teaching_site_id},
		available_date => $fdat{available_date},
		prelim_due_date => $fdat{prelim_due_date},
		due_date => $fdat{due_date},
		question_stylesheet => $fdat{question_stylesheet},
		results_stylesheet => $fdat{results_stylesheet},
		);
	    ($res, $msg) = $new_eval->save();
            if ($res) {
        	my $new_uri = $req_rec->uri();
        	$new_uri =~ s!/*$!/!;
        	$new_uri .= $new_eval->primary_key() . "?NEW_EVAL=" . $new_eval->primary_key();
        	$req_rec->header_out(Location => $new_uri);
        	$req_rec->status(REDIRECT);
        	Apache::exit();
	    } else {
		

	    }
        }
    }

    our $courses = TUSK::Core::HSDB45Tables::Course->new()->getWithTeachingSites($school);

    my $blank_tp = HSDB45::TimePeriod->new( _school => $school );
    our @timeperiods = $blank_tp->nonpast_time_periods();

    our $eval_editable = 0;
    our $eval = $blank_eval;
    our $eval_id = $path[2];
    our @questions; 
    if ($eval_id) {
        $eval = HSDB45::Eval->new( _school => $school, _id => $eval_id);
	
        my @fields = qw(title course_id time_period_id teaching_site_id available_date prelim_due_date due_date);
        if ($eval->primary_key()) {
	    if ($fdat{duplicate_eval}) {
		($res, $msg) = 
		    HSDB45::Eval::Authoring::duplicate_eval($school, $eval);
		if ($res) {
	            my $new_uri = sprintf("/eval_edit/%s/%d?DUPLICATE=%d", $school, 
			$res, $eval->primary_key());
	            $req_rec->header_out(Location => $new_uri);
	            $req_rec->status(REDIRECT);
	            Apache::exit();
		}
	    }
            $eval_editable = $eval->is_editable();
            if ($fdat{edit_eval}) {
		($res, $msg) = HSDB45::Eval::Authoring::check_field_values(\%fdat);
		if ($res && $eval_editable) {
		    $eval->set_field_values(title => $fdat{title},
			course_id => $fdat{course_id},
			time_period_id => $fdat{time_period_id},
	 		teaching_site_id => $fdat{teaching_site_id},
			available_date => $fdat{available_date},
			prelim_due_date => $fdat{prelim_due_date},
			due_date => $fdat{due_date},
			question_stylesheet => $fdat{question_stylesheet},
			results_stylesheet => $fdat{results_stylesheet},
			);
		}
		elsif ($res) {
		    $eval->set_field_values(
			available_date => $fdat{available_date},
			due_date => $fdat{due_date},
			prelim_due_date => $fdat{prelim_due_date},
			question_stylesheet => $fdat{question_stylesheet},
			results_stylesheet => $fdat{results_stylesheet},
			);
		}
		if ($res) {
			    ($res, $msg) = $eval->save(); 
		}
            }
            else {
                for my $field (@fields) { 
		    $fdat{$field} = $eval->field_value($field);
		    $fdat{$field} =~ s/\"/\&\#34;/g;
		}
            }
            if ($eval_editable && $fdat{copy_eval}) {

		### eval_id in the input box (eval_to_copy_2) has priority over the one in the select box (eval_to_copy)
		### eval_to_copy will be used only if eval_to_copy_2 is empty
 
		my $eval_to_copy = (defined $fdat{eval_to_copy_2}) ? $fdat{eval_to_copy_2} : $fdat{eval_to_copy};
                ($res, $msg) = 	HSDB45::Eval::Authoring::copy_eval_questions($school, $eval_to_copy, $eval->primary_key());
            }
	    elsif ($fdat{do_edit}) {
		my $answered_hash = {};
		my @unlinks = split(/\t/, $fdat{unlink_q});
		my @edits = split(/\t/, $fdat{edit_q});
		my @duplicates = split(/\t/, $fdat{duplicate_q});
		foreach my $qid (@unlinks) {
		    my $q = $eval->question($qid);
		    if (!$q || $answered_hash->{$qid}) {
			$msg .= "Can't unlink $qid";
			next; 	
		    } elsif ($answered_hash->{$qid} = $q->has_been_answered($eval_id)){
			$msg .= "Can't unlink $qid";
			next;
		    }
		    ($res, $msg) = $eval->delete_child_question($qid);
		    my $docid = $school . "_" . $eval_id . "_" . $qid;
		    TUSK::FTS::Eval::Index::deleteDocument($docid);
		    last unless $res;
		}

		foreach my  $qid (@duplicates) {
		    my $q = $eval->question($qid);
		    if (!$q || $answered_hash->{$qid}) {
			$msg .= "Can't duplicate $qid";
			next; 	
		    } elsif ($answered_hash->{$qid} = $q->has_been_answered($eval_id)){
			$msg .= "Can't duplicate $qid";
			next; 	
		    } 
		    ($res, $msg) = HSDB45::Eval::Authoring::make_question_duplicate(
			$school, undef, 
			undef, $eval, $qid);
			if ($res) { push @edits, $res; }
		    last unless $res;
		}
		if (@edits && $res) {
		    my @real_edits = ();
		    for my $qid (@edits) {
			my $q = $eval->question($qid);
			next unless $q and $q->primary_key();
			next if $q->has_been_answered();
			push @real_edits, $qid; 
		    }
		    my $edit_uri = sprintf("/eval_question_edit/%s/%d/%s",
			$school, $eval->primary_key(),
			join('/', map { sprintf("%d", $_) } @real_edits));
		    $req_rec->header_out(Location => $edit_uri);
		    $req_rec->status(REDIRECT);
		    Apache::exit();
		}
	    } 

            @questions = $eval->questions();
            if ($fdat{add_question}) {
		($res, $msg) = HSDB45::Eval::Authoring::create_question($school,
			undef, undef,
			$eval, $fdat{new_q_type}, $fdat{new_q_after});
                if ($res) {
		    my $question_uri = sprintf("/eval_question_edit/%s/%d/%d",
			$school, $eval->primary_key(), $res);
	            $req_rec->header_out(Location => $question_uri);
        	    $req_rec->status(REDIRECT);
	            Apache::exit();
                }
	    }

	    if($eval_editable && $fdat{automate_all_labels}) {
	        $eval->automate_all_labels();
		@questions = $eval->questions();
	    }
        }
    }
    else {
	$eval_editable = 1;
    }

    $escmode = 0;
    our $embperldir=$req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});
    Execute ({inputfile => "$embperldir/eval_question.html", import => 1});
    Execute ({inputfile => "$embperldir/element", import => 1});
-]

[$ sub action_row $]
[- ($name, $value) = @_; -]
<tr><td bgcolor="#ccccff">
<input type="submit" name="[+ $name +]" value="[+ $value +]" />
</td></tr>
[$ endsub $]

[# Make the title #]
<html>
<head>
<title>[+ $TUSK::Constants::SiteAbbr +] Eval Authoring</title>
<style type="text/css">@import url(/style/calendar-blue.css);</style>
<script language="Javascript" src="/scripts/calendar.js"></script>
<script language="Javascript" src="/scripts/calendar-en.js"></script>
<script language="Javascript" src="/scripts/calendar-setup.js"></script>
<script language="Javascript" src="/scripts/scripts.js"></script>
<script language="Javascript" src="/scripts/eval.js"></script>
<script language="Javascript" src="/scripts/formbuilder.js"></script>
[-
    # Import the style sheet
    Execute ("$embperldir/hsdb4-style.css")
-]
</head>
<body>

[- Execute ("$embperldir/userbox.html",undef,$user) -]
[- Execute({inputfile=>"$embperldir/element",sub=>'page_title',
		param=>["Eval " . ($eval->primary_key() ? "Editing:" : "Creation: ") . ucfirst($school) ]});-]

<div><a href="/eval/administrator/show/[+ $school +]"> Manage Evaluations </a></div>

[$ if ($eval_id) $]
<div><a href="/hsdb45/eval/filter_creator/[+ $school +]/[+ $eval_id +]">
Add Filter</a></div>
[$ endif $]

[$ if ($msg) $]
[- @msgs = split ("\n", $msg); -]
<div class="error">
[$ foreach $message @msgs $]
[+ $message +]<br>
[$ endforeach $]
</div>
[$ endif $]

[$ if ($fdat{DUPLICATE}) $]
<div class="error">Eval ID=[+ $fdat{DUPLICATE} +] has been copied to this new eval.</div>
[$ endif $]

[$ if ($fdat{NEW_EVAL}) $]
<div class="error">New eval has been created; eval ID = [+ $fdat{NEW_EVAL} +]</div>
[$ endif $]

<h3 class="title">Eval Information</h3>
[$ if not $eval_editable $]
<div class="error">Eval has been answered; only its dates/stylesheets can be edited. And questions can only be added, not deleted or modified.</div>
[$ endif $]


<form name="eval_create" method="post">
<table border="0" cellpadding="3" class="wide">

[$ if ($eval && $eval->primary_key()) $]
[$ if ($eval_editable) $]
<tr><td align="left" colspan="2">You can <strong>edit the eval information</strong> here: that is, its title, course, time period, due date information, and stylesheet information. To cause the changes to take effect, enter your user name and password and choose "Save Changes". When you do, the eval will be changed, and you will continue to work with this eval. If you need to create new courses or new time periods, you can do that <a href="/manage/">here</a>.</td></tr>
[$ else $]
<tr><td align="left" colspan="2">Because this eval has already been answered, its title, course, teaching site and time period information cannot be changed. However, if necessary, you can <strong>change its date and stylesheet information</strong> here. To cause your changes to take effect, enter your user name and password below, and choose "Change Dates/Stylesheets".</td></tr>
[$ endif $]

<tr>
  <td align="right"><b>Eval ID:</b></td>
  <td align="left">[+ $eval->primary_key() +] (<a href="/eval45/[+ $school +]/[+ $eval->primary_key() +]" target="_blank" >Preview this eval</a>.)</td>
</tr>
[$ else $]
<tr><td align="left" colspan="2">To <strong>create a new eval</strong>, enter the title, course, time period, date and stylesheet information below. Then, enter your user name and password and choose "Create New Eval". After you do this, a new eval will be created, and you will be able to add questions to it (either from scratch or by copying them from another eval). If you need to create new courses or new time periods, you can do that <a href="/manage/">here</a>.</td></tr>
[$ endif $]


<tr><td align="right"><b>Title:</b></td>
<td align="left">
[$ if $eval_editable $]
<input type="text" name="title" size="50" />
[$ else $]<span class="title">[+ $fdat{title} +]</span>
<input type="hidden" name="title" />
[$ endif $]
</td></tr>

<tr><td align="right" valign="top"><b>Course:</b></td>
<td align="left">
[$ if $eval_editable $]
  <select name="course_id" size="6"  onChange="displayList(this.selectedIndex)">
    [$ foreach $course @$courses $]
     <option value="[+ $course->getPrimaryKeyID() +]">[+ $course->getTitle() +] ([+ $course->getPrimaryKeyID() +])</option>
    [$ endforeach $]
  </select>
[$ else $]
[- $course = $eval->course() -]
[+ $course->field_value('oea_code') ? $course->field_value('oea_code') : '-' +] 
: [+ $course->out_label() +] ([+ $course->primary_key() +])
<input type="hidden" name="course_id" />
[$ endif $]
</td></tr>

<tr><td align="right" valign="top"><b>Teaching Site:</b></td>
<td align="left">

<select name="teaching_site_id" size="2" style="width: 450px" onClick="alertMissing(this);"></select>

   <script type="text/javascript">
   var courses = document.eval_create.course_id;
   var teaching_sites_group = document.eval_create.teaching_site_id;
   var teaching_site_id = new Array();
     [-  $i = 0 -]
     [$ foreach $course (@$courses) $]    
         [- our $links = $course->getLinkTeachingSiteObjects() -]
 	teaching_site_id[ [+ $i++ +] ] = [ "0|None"
 	[$ foreach $link (@$links) $]
 	  [$ if ($link->getPrimaryKeyID() && ref($link->getTeachingSiteObject()) eq 'TUSK::Core::HSDB45Tables::TeachingSite') $]
 	  [- our $teaching_site = $link->getTeachingSiteObject();  -]
           ,"[+ $teaching_site->getPrimaryKeyID() +]|[+ $teaching_site->getSiteName() +]"
          [$ endif $]
         [$ endforeach $]
 	];
     [$ endforeach $]
 
     [-
 	our $highlight_site_id = 0;
 	if ($fdat{teaching_site_id}) {
 		$highlight_site_id = $fdat{teaching_site_id};
 	} elsif ($eval->field_value('teaching_site_id')){
 		$highlight_site_id = $eval->field_value('teaching_site_id');
 	}
     -]
 
     if (eval_create.course_id.selectedIndex != -1) {
        displayList(eval_create.course_id.selectedIndex);
 	for (var i=0; i<eval_create.teaching_site_id.options.length; i++){
 		if (eval_create.teaching_site_id.options[i].value == [+ $highlight_site_id +]){
 			eval_create.teaching_site_id.selectedIndex = i;
 			break;
 		}
 	}
     } 


 
     function displayList(selectedGroup){
 	teaching_sites_group.options.length = 0;
 
 	for (i=0; i<teaching_site_id[selectedGroup].length; i++) {
 		var default_selected = false;
 		var selected_choice = false;
 		if (eval_create.teaching_site_id.selectedIndex != -1) {
 			if (i == 0) default_selected = true;
 		        selected_choice = true;
 		}
 		teaching_sites_group.options[teaching_sites_group.options.length] = new Option(teaching_site_id[selectedGroup][i].split("|")[1], teaching_site_id[selectedGroup][i].split("|")[0], default_selected, selected_choice );
 	}
 	eval_create.teaching_site_id.selectedIndex = 0;
      }


      function alertMissing(teaching_site) {
	 	if (teaching_site.selectedIndex == -1 ) { 
			alert('Please click on a course to get a list of corresponding teaching sites.');
		}
      }
   </script>
</td></tr>

<tr><td align="right" valign="top"><b>Time Period:</b></td>
<td align="left">
[$ if $eval_editable $]
  <select name="time_period_id" size="4">
    [$ foreach $tp (sort { $b <=> $a } @timeperiods) $]
    <option value="[+ $tp->primary_key() +]">[+ $tp->primary_key() +]: [+ $tp->out_label() +]
    [$ if ($tp->start_date()->has_value() && $tp->end_date()->has_value()) $] ([+ $tp->start_date()->out_mysql_date() +] to [+ $tp->end_date()->out_mysql_date() +])[$ endif $]</option>
    [$ endforeach $]
  </select>
[$ else $]
  [- $tp = $eval->time_period() -]
  [+ $tp->out_label() +]
  [$ if ($tp->start_date()->has_value() && $tp->end_date()->has_value()) $]
	  ([+ $tp->start_date()->out_mysql_date() +] to [+ $tp->end_date()->out_mysql_date() +])
   <input type="hidden" name="time_period_id" />
  [$ endif $]
[$ endif $]
</td></tr>

[-
my $avail_params =  [
             { 	label => '<b>Available Date:</b>',
				td_class => '',
				td_align => 'right',
				input_td_class => '',
				input_td_align => 'left',
				name =>  'available_date',
				value => $eval->field_value('available_date'),
				calendar => 1,
             } ];

Execute ({inputfile => $embperldir."/element", 
          sub       => 'textbox', 
          param     => $avail_params
         }); 

my $p_due_params =  [
             { 	label => '<b>Preliminary Due Date:</b>',
				td_class => '',
				td_align => 'right',
				input_td_class => '',
				input_td_align => 'left',
				name =>  'prelim_due_date',
				value => $eval->field_value('prelim_due_date'),
				calendar => 1,
             } ];

Execute ({inputfile => $embperldir."/element", 
          sub       => 'textbox', 
          param     => $p_due_params
		});

my $due_params =  [
             { 	label => '<b>Due Date:</b>',
				td_class => '',
				td_align => 'right',
				input_td_class => '',
				input_td_align => 'left',
				name =>  'due_date',
				value => $eval->field_value('due_date'),
				calendar => 1,
             } ];

Execute ({inputfile => $embperldir."/element", 
          sub       => 'textbox', 
          param     => $due_params
		});
-]

<tr>
  <td align="right"><b>Question Stylesheet:</b></td>
  <td align="left">
    <select name="question_stylesheet">
      <option value="">Default Question Stylesheet</option>
    [$ foreach $stylesheet ($eval->question_stylesheets()) $]
      <option value="[+ $stylesheet->stylesheet_id() +]"
		     [$ if (defined($eval->question_stylesheet_id())) $]
                     [+ 'selected="true"' 
			if($eval->question_stylesheet_id() == $stylesheet->stylesheet_id())+]
		     [$ endif $]>
        [+ $stylesheet->stylesheet_id() +]: [+ $stylesheet->label() +]
      </option>
    [$ endforeach $]
    </select>
  </td>
</tr>

<tr>
  <td align="right"><b>Results Stylesheet:</b></td>
  <td align="left">
    <select name="results_stylesheet">
      <option value="">Default Results Stylesheet &nbsp;&nbsp;</option>
    [$ foreach $stylesheet ($eval->results_stylesheets()) $]
      <option value="[+ $stylesheet->stylesheet_id() +]"
                     [+ 'selected="true"' if($eval->results_stylesheet_id() == $stylesheet->stylesheet_id())+]>
        [+ $stylesheet->stylesheet_id() +]: [+ $stylesheet->label() +]
      </option>
    [$ endforeach $]
    </select>
  </td>
</tr>

</table>


<table width="100%" cellpadding ="2">
[$ if $eval->primary_key() $]
   [- action_row("edit_eval", "Save Changes") -]
[$ else $]
   [- action_row("new_eval", "Create New Eval") -]
[$ endif $]
</table>

</form>

[$ if ($eval->primary_key() && @questions && ! $eval_editable) $]
	<h4 class="title">Copy This Eval</h4>
	<p>You may <strong>create a new eval</strong> which is a copy of <em>this</em> eval 
	(which you can then edit) by entering your username and password below and choosing 
	"Copy This Eval". If you do that, a new eval will be created whose information 
	(title, course, dates, etc.) will be exactly the same as this eval, with the set 
	of questions here linked to it. You will be able to edit that eval's information 
	and manipulate its question list.</p>
<table width="100%" cellpadding ="2">
	[- action_row("copy_eval","Copy this Eval"); -]
</table>
[$ endif $]
 

[$ if $eval->primary_key() $]
	<h3 class="title">Question List</h3>
	[$ if (@questions == 0) $]
		<p>There are no questions entered for this eval. 
		There are two approaches to adding questions to this eval.</p>
		<ol>
		<li>You may <strong>copy the question list from another eval</strong> by 
		following the instructions under "Copy Questions from Another Eval"; or</li>
		<li>You may <strong>make a new question from scratch</strong>
		 to add to this eval by following the instructions under "Add a Question to This Eval".</li>
		</ol>
		<h4 class="title">Copy Questions from Another Eval</h4>
		<p>You <strong>copy the list of questions from another eval</strong> to this eval 
		by selected the other eval below, entering your username and password, and choosing
		"Copy Questions from Eval". When you do this, the questions which are linked to 
		the other eval will become linked to this eval, and you will be able to work with them here.</p>
		<form name="copy_eval" method="post" onsubmit="return validateForm(this)">
		<table border="0" cellspacing="0" cellpadding="2" class="wide">
		<tr><td align="right"><b>Copy Eval:</b></td>
		<td align="left"><select name="eval_to_copy">
		[$ foreach  $other $blank_eval->lookup_conditions('course_id = ' . $eval->field_value ('course_id') . ' and eval_id != ' . $eval->field_value('eval_id')) $]
			<option value="[+ $other->primary_key() +]">
				[+ $other->out_label() +] ([+ $other->primary_key() +])
			</option>
		[$ endforeach $]
		</select></td></tr>
                <tr><td>&nbsp;</td>
                <td align="left">Alternatively, you may enter an Eval ID: &nbsp;<input type="text" name="eval_to_copy_2"></td></tr>
		</table>
		<table width="100%" cellpadding ="2">
		[- action_row("copy_eval", "Copy Questions from Eval") -]
		</table>
		</form>

	       <script type="text/javascript">
		function validateForm(form) {
			
			var str = form.eval_to_copy_2.value;
			if (str == null || str.length == 0) {
				return true;
			}

			if (isValidIdWithoutLeadingZeroes(form.eval_to_copy_2)) {
				return true;
			}
			return false;
		}
	       </script>

	[$ else $]
		<p>You can <strong>manipulate the question list</strong> of this eval here. 
		The list of all of the questions (along with their information) is shown below. 
		You can do the following things to a question:</p>
		<ul>
		<li><strong>Unlink</strong> it from this eval (this does not delete the question 
		or affect its relationship with other evals).</li>
		<li><strong>Edit</strong> the question itself. This option will let you edit the question 
		information. This option is not available if the question is part of another eval 
		that has already been answered.</li>
		<li><strong>Duplicate and then edit</strong> the question. 
		This will make a duplicate of the question, unlink the original question, 
		link the duplicate question, and edit the newly duplicated question.</li>
		</ul>
		<p>For each question you wish to manipulate, choose the checkbox next to the action 
		to the right of the question below. After you have selected all of the questions 
		you with to unlink, duplicate, and edit, enter your password below and choose 
		"Create and Edit Questions". If you are editing any questions (possibly after duplicating them), 
		you will be taken to a page where you can do that.</p>

		<form name="question_automation" method="post">
		<table border="0" cellspacing="0" cellpadding="2" class="wide">
		<tr bgcolor="#ccccff">
		[$ if $eval_editable $]
			<td style="text-align:left">
			<input type="submit" name="automate_all_labels" value="Automate All Labels" />
			</td>
		[$ endif $]
		<td style="text-align:right">
		<input type="button" onclick="eval_select_all(true);" 
		name="edit_select_all" value="Edit All" />
		<input type="button" onclick="eval_select_all(false);" 
		name="edit_clear_all" value="Deselect All" />
		</td></tr>
		</table>
		</form>


		<form name="question_list" method="post">
		<table border="0" cellspacing="0" cellpadding="2" class="wide">
		[$ foreach $qn (@questions) $]
			[- question_info($qn,$eval_id,$eval_editable) -]
		[$ endforeach $]
		<tr><td colspan="2" bgcolor="#ccccff" style="text-align:left">
		<input type="submit" name="do_edit" value="Unlink and Edit Questions" />
		</td></tr>
		</table>
		</form>

	[$ endif $]

	<h4 class="title">Add a Question to This Eval</h4>
	<p>You may <strong>add a new question</strong> to his eval by choosing its type 
	[$ if @questions $]
		and the question it will follow in the sort order
	[$ endif $] 
	below, and entering your name and password. If you do this, a new question will be created and linked to this eval, and you will be taken to a page to edit the new question.</p>
	<form name="add_question" method="post">
	<table border="0" cellspacing="0" cellpadding="2" class="wide">
	<tr><td align="right"><b>New Question Type: </b>
	[# Name is new_q_type #]

	<td align="left">[- question_type_select($eval_editable) -]</td></tr>
	[$ if @questions $]
		<tr><td align="right"><b>Preceding Question:</b></td>
		<td align="left"><select name="new_q_after">
		<option value="0">Beginning</option>
		[$ foreach $question @questions $]
			<option value="[+ $question->primary_key() +]">
				[+ $question->out_text_display() +]
			</option>
		[$ endforeach $]
		</select></td></tr>
	[$ endif $]

		<tr bgcolor="#ccccff" ><td colspan="2"  style="text-align:left">
		<input type="submit" name="add_question" value="Create Question" /></td>
		<td><input type="button" value="Question Authoring Help" onClick="doHelpWindow()" /></td>
		<td><input type="button" value="Directory of This Eval" 
		onClick="doQuickRefWindow('[+ $school . "/" . $eval->primary_key() +]')" /></td>
		</tr>
	</table>
	</form>

[$ endif $]

<hr/>
[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html")) -]
</body>
</html>

