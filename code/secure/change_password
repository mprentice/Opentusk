<HTML>
<HEAD>
[! use HSDB4::SQLRow::User;
   use Apache::Constants qw(REDIRECT);
   use Apache::Cookie;
 !]
[- 
 $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});
 Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});

 # Get the authenticated user
 %cookies = Apache::Cookie->new($req_rec)->parse;
 %ticket = $cookies{'Ticket'}->value;
 $username = $ticket{'user'};
 $user = HSDB4::SQLRow::User->new ()->lookup_key($username);
 $chpw = 1 if $user->field_value('profile_status') =~ /ChangePassword/;
 $res = 0;
 if (keys %fdat) {
   ($res, $msg) =$user->user_change_password(@fdat{qw(old_pw new_pw new_pw2)});
   if ($res) {
     $req_rec->header_out("Location" => "/");
     $req_rec->status(REDIRECT);
   }
   @fdat{qw(old_pw new_pw new_pw2)} = ('', '', '');
 }
 # Get the style sheet
 Execute ("$embperldir/hsdb4-style.css");
-]
<BODY>
 [- head_graphics("Change Password"); -]

[# Are there error messages to relay? #]
[$ if $msg $]
<DIV CLASS="error">Could not change password: [+$msg+]</DIV>
<DIV CLASS="error">Please try again.</DIV>
[$ elsif $chpw $]
<DIV CLASS="error">Your password has expired.  You need to change it
before continuing on.</DIV>
[$ endif $]

<P>To change your password, please enter your <strong>old</strong>
password in the "Old password" box, and then enter your new password
twice; once into each of the new password boxes. Then, press the 
<strong>submit</strong> button,
and we'll attempt to save your changes.  If there's a problem, we'll
tell you what happened as best we can, and let you try again.  If
there's no problem, you'll be taken to the home page, and the next
time you log in, you'll use your <strong>new</strong> password. </P>

<P>Thank you for your patience.</P>

<P>Rules for your new password:</P>
<UL>
<LI>It <strong>must</strong> be more than six characters long.
<LI>It <strong>must</strong> be different from the old password.
</UL>

<FORM METHOD=POST>
<TABLE>
<TR><TD ALIGN="RIGHT">Old password:</TD>
<TD><INPUT TYPE=PASSWORD NAME="old_pw" SIZE=30></TD></TR>
<TR><TD ALIGN="RIGHT">New password:</TD>
<TD><INPUT TYPE=PASSWORD NAME="new_pw" SIZE=30></TD></TR>
<TR><TD ALIGN="RIGHT">New password again:</TD>
<TD><INPUT TYPE=PASSWORD NAME="new_pw2" SIZE=30></TD></TR>
<TR><TD>&nbsp;</TD>
<TD><INPUT TYPE="SUBMIT" Value="Submit Password"><INPUT TYPE="RESET"></TD></TR>
</TABLE>
</FORM>
</BODY>
</HTML>
