<HTML>
<HEAD>
[! use HSDB4::SQLRow::Content;
   use Apache::Constants qw(REDIRECT);
   use Apache::URI;
!]
[# Figure out what document we are #]
[-
    $req_rec->no_cache();
    $path = $req_rec->path_info;
    $doc = HSDB4::SQLRow::Content->new()->lookup_path ($path);
    if ($doc->display_framed) {
	$req_rec->header_out (Location => "/hsdb4/url_frame$path");
	$req_rec->status(REDIRECT);
	exit;
    }

    # If there's been a note submitted, save it
    if ($fdat{'user_note'}) {
       $doc->make_annotation ($req_rec->connection->user, $fdat{'user_note'});
    }

    $escmode = 0;

    # Read in my handy-dandy auxiliary functions
    $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});
    Execute ("$embperldir/caper-style.css");
-]

[# Make the title #]
<TITLE>TUSK [+ ucfirst $doc->field_value('type') +]: 
[+ $doc->field_value('title') +]</TITLE>

</HEAD>
<BODY>

[# Anchor for the top #]
<A NAME="_top"></A>
[$ if not $fdat{'PRINT'} $]
[# The navigation bar #]
[- Execute ("$embperldir/navbar.html", $doc) -]
[$ endif $]

[$ if not $fdat{'PRINT'} $]
[# Put in the user box #]
[- Execute ("$embperldir/caper_userbox.html") -]
[$ endif $]

[# Make the title #]
<H2 class="title">[+ $doc->field_value('title') +]</H2>

[$ if not $fdat{'PRINT'} $]
[# Make the nice links #]
<DIV CLASS="auxlinks">
<A HREF="[- uri_flag ('INFO', $fdat{'INFO'} ? 0 : 1) -]">[+ $fdat{'INFO'} ? "Hide" : "View" +] document info</A>
<IMG SRC="/icons/transdot.gif" WIDTH=8 HEIGHT=1>
[#  Not ready for this yet...
<A HREF="[+ $doc->out_discuss_url +]">Discuss document</A>
<IMG SRC="/icons/transdot.gif" WIDTH=8 HEIGHT=1>
#]
[$ if not HSDB4::Constants::is_guest ($user) $]
<A HREF="[- uri_flag ('NOTE', 1) -]">Annotate document</A>
<IMG SRC="/icons/transdot.gif" WIDTH=8 HEIGHT=1>
[$ endif $]
<A HREF="[- uri_flag ('PRINT', 1) -]">Get printable version</A>
</DIV>
[$ endif $]

[# Document Info #]
[$ if $fdat{'INFO'} $]
[- @authors = $doc->child_users;
   @keywords = $doc->keywords;
   $course = $doc->course;
   @objectives = $doc->parent_objectives;
-]

[$ if @authors $]
<H3 CLASS="title">Authors</H3>
<UL>
[- $author = @authors[$row] -]
[$ if $author $]
<DIV CLASS="docinfo"><LI>[+ $authors[$row]->out_html_full_name +]</DIV>
[$ endif $]
</UL>
[$ endif $] [# End putting in authors #]

[$ if $course $]
<H3 CLASS="title">Course</H3>
<UL>
<DIV CLASS="docinfo"><LI>[+ $course->out_html_label +]</DIV>
</UL>
[$ endif $] [# End putting in course #]

[$ if @keywords $]
<H3 CLASS="title">Keywords</H3>
<UL>
[- $keyword = $keywords[$row] -]
[$ if $keyword $]
<DIV CLASS="docinfo"><LI>[+ $keyword->out_html_label +] ([+ $keyword->field_value('type') +])</DIV>
[$ endif $]
</UL>
[$ endif $] [# End putting in keywords $]

[$ if @objectives $]
<H3 CLASS="title">Objectives</H3>
<UL>
<DIV CLASS="docinfo"><LI>[+ $objectives[$row]->out_html_label +]</DIV>
[$ endif $] [# End putting in objectives #]

[$ endif $] [# End putting in INFO #]

[# User annotation #]
[$ if $fdat{'NOTE'} $]
[-
   # Get the notes
   @notes = $doc->child_personal_content ($req_rec->connection->user);
-]
[$ if $fdat{'PRINT'} $]
<TABLE CLASS="wide" BGCOLOR="#cccccc" BORDER=0 CELLSPACING=0 CELLPADDING=3>
<TR><TD><H3 class="title">User Notes</H3></TD></TR>
<TR><TD>
[-
   $noteval = join ("\n\n", map { $_->field_value('body') } @notes);
-]
<P>[+ $noteval +]
</TD></TR>
</TABLE>
[$ else $]
<FORM METHOD="POST">
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0>
<TR><TD><H3 class="title">User Notes</H3></TD></TR>
<TR><TD>
<TEXTAREA NAME="user_note" ROWS=8 WRAP="VIRTUAL" COLS=80>
[+ join ("\n", map { $_->field_value('body') } @notes) +]
</TEXTAREA>
</TD></TR>
<TR><TD>
<INPUT TYPE="SUBMIT" VALUE="Save Notes">
<INPUT TYPE="HIDDEN" NAME="NOTE" VALUE="1">
<A HREF="[- uri_flag ('NOTE', 0) -]">Close Note</A>
</TD></TR>
</TABLE>
</FORM>
[$ endif $]
[$ endif $]

[# The actual body #]
[- $body = $doc->out_html_body (%fdat);
   $length = length($body); -]
[+$body+]

[# Display the document list #]
[- @content = $doc->child_content; -]
[$ if (@content > 0) $]
<H3 CLASS="title">Linked Documents</H3>
<TABLE CLASS="wide">
[# This should be done from the object #]
<TR><TH ALIGN=LEFT>Type</TH><TH COLSPAN=2 ALIGN=LEFT>Document</TH><TH ALIGN=LEFT>Authors</TH></TR>
[$ foreach $doc @content $]
[+ $doc->out_html_row +]
[- $length += 300 -]
[$ endforeach $]
</TABLE>
[$ endif $]

[- $length += ($appendix = $doc->out_html_appendix) -]
[$ if $appendix $]
[+$appendix+]
[$ endif $]

[# The navigation bar #]
[$ if (($doc->isa('HSDB4::SQLRow::Content::Slide') || $length > 5000)
	and not $fdat{'PRINT'}) $]
[- Execute ("$embperldir/navbar.html", $doc) -]
[$ endif $]
</BODY>
</HTML>






