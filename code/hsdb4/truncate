<HTML>
<HEAD>
[! 
   use HSDB4::SQLRow::Content;
   use HSDB4::SQLRow::User;
   use HSDB4::XML::HSCML;
!]
[# Figure out what document we are #]
[-
    $req_rec->no_cache();
    $path = $req_rec->path_info;
    $doc = HSDB4::SQLRow::Content->new()->lookup_path ($path);
    if (!$doc->primary_key) {
	$req_rec->header_out (Location => "/missing_page");
	$req_rec->status(REDIRECT);
	exit;
    }

    # Find the user name
    $user = $req_rec->connection->user;

    # Read in my handy-dandy auxiliary functions
    $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});

    if ($doc->field_value('style')) {
	    Execute ("$embperldir/".$doc->field_value('style').".css");
    } else {
	    Execute ("$embperldir/hsdb4-style.css");
    }	

    $xsl_dir = $req_rec->server_root_relative("code/XSL");

    $twig_body = HSDB4::XML::HSCML->new($doc->out_hscml());
    $parsed_body = $twig_body->parse_sub_body($fdat{node}, $doc);
    $doc->field_value('hscml_body', '<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE content SYSTEM "hscml.dtd"><db-content><body>' . $parsed_body. '</body></db-content>');
    $doc->xsl_stylesheet($xsl_dir."/Content/Document.xsl");
    $body = $doc->out_html_body(%fdat);
   
-]
</HEAD>
<BODY>
[+ $body +]
</BODY>
</HTML>











