<HTML>
<HEAD>
[! use HSDB4::SQLRow::Content;
   use HSDB4::SQLRow::User;
   use HSDB4::SQLRow::Answer;
   use HSDB4::SQLRow::ContentDraft;
   use Apache::Constants qw(REDIRECT);
!]
[# Figure out what document we are #]
[-
    $req_rec->no_cache();
    $path = $req_rec->path_info;
    $doc = HSDB4::SQLRow::Content->new();
    $doc->lookup_path($path);
    if (!$doc || ($doc->field_value("type") !~ /Document/)) {
	$req_rec->header_out (Location => "/missing_page");
	$req_rec->status(REDIRECT);
	exit;
    }

    # Find the user name
    $user = $req_rec->connection->user;
    $user_obj = HSDB4::SQLRow::User->new->lookup_key ($user);

    # Read in my handy-dandy auxiliary functions
    $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});
    if ($doc->field_value('style')) {
	    Execute ("$embperldir/".$doc->field_value('style').".css");
    } else {
	    Execute ("$embperldir/hsdb4-style.css");
    }	
    $maxcol=5;
    $draft = HSDB4::SQLRow::ContentDraft->new();
    $draft->lookup_content($doc->primary_key);
    if (!$draft->primary_key) {
	$req_rec->header_out (Location => "/missing_page");
	$req_rec->status(REDIRECT);
	exit;
    }
    $body = $draft->out_draft_body;
    $title = $draft->out_draft_title;
-]
[# Make the title #]
<TITLE>[+ $TUSK::Constants::SiteAbbr +] Draft Document: 
[+ $title +]</TITLE>
</HEAD>
<BODY>

[# Anchor for the top #]
<A NAME="_top"></A>

[# Put in the user box #]
[- Execute ("$embperldir/userbox.html", $doc) -]
[# The navigation bar #]
[- Execute ("$embperldir/navbar.html", $doc) -]

[# Make the title #]
<H2 class="title">[+ $title +]</H2>

[# The actual body #]
[- $length = length($body); -]
[+$body+]

</BODY>
</HTML>











