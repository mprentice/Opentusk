<HTML>
<HEAD>
[! use HSDB4::SQLRow::Content;
   use HSDB4::SQLRow::User;
   use Apache::Constants qw(REDIRECT NOT_FOUND);
   use Data::Dumper;
!]
[# Figure out what document we are #]
[-
    $req_rec->no_cache();
    $path = $req_rec->path_info;
    $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});
    if ($path eq ''){
        Execute({inputfile => "$embperldir/missingHandler.html"});
	exit;
    }
    @path = grep { /\S/ } split '/',$path;
    if ($path[0]){
	    $user = $req_rec->connection->user;

	    $orig_doc = HSDB4::SQLRow::Content->new()->lookup_key($path[0]);

	    unless ($orig_doc->is_user_authorized($user)){
		$msg = "Permission denied";
	    }

	    if (!defined($orig_doc) || !$orig_doc->primary_key()){
		$msg = "Can't find the content for ID: " . $path[0];
	    } else {
		    if ($path[1]){
			   $history_doc = HSDB4::SQLRow::ContentHistory->new()->lookup_key($path[1]);
		    } else {
			    @docs = HSDB4::SQLRow::ContentHistory->new()->lookup_conditions("content_id = ".$path[0]);
		    }
		    if (!scalar(@docs) && !defined($history_doc)) {
			$msg = 'No History Found for content ID: ' . $path[0];
		    } elsif (defined($history_doc) && !$history_doc->primary_key()){
			$msg = 'History record not found for ID: ' . $path[1];
		    }
		 
		    $xsl_dir = $req_rec->server_root_relative("code/XSL");

		    # Find the user name
		    $user_obj = HSDB4::SQLRow::User->new->lookup_key ($user);
		    if ($orig_doc->field_value('style')) {
			    Execute ("$embperldir/".$orig_doc->field_value('style').".css");
		    } else {
			    Execute ("$embperldir/hsdb4-style.css");
		    }
	    }
    } else {
	$msg = "Invalid ID passed";
    } 

    # Read in my handy-dandy auxiliary functions
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});
-]
[# Make the title #]
[$ if ($msg) $]
<TITLE>Content not Found.</TITLE>
</HEAD>
[- Execute ("$embperldir/userbox.html", $doc) -]
<BODY>
<H2 class="title">[+ $msg +]</H2>

[$ else $]
<TITLE>[+ $TUSK::Constants::SiteAbbr +] [+ ucfirst $orig_doc->type +]: 
[+ $orig_doc->out_label +]</TITLE>
[+$orig_doc->out_meta_data;+]
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<script language=JavaScript src="/scripts/content.js" type=text/javascript></script>
</HEAD>
<BODY>

[# Anchor for the top #]
<A NAME="_top"></A>

[# Put in the user box #]
[- Execute ("$embperldir/userbox.html", $doc) -]
[# Make the title #] 
<H2 class="title">[+ $orig_doc->out_label +]</H2>
[$ if (!defined($history_doc) || !$history_doc->primary_key()) $]
<A HREF="/hsdb4/content/[+ $orig_doc->primary_key() +]">Return to Original Content Page</A>
<p>
Please select history record to view:
</p>
[- $time = HSDB4::DateTime->new;
   $blank_user = HSDB4::SQLRow::User->new();
 -]
<table>
[$ foreach $history_item (@docs) $]
[- 
$time->in_mysql_timestamp($history_item->field_value("modified"));
$history_user = $blank_user->lookup_key($history_item->field_value('modified_by'));
$history_name = sprintf("%s (Record as of %s) Modified By %s",$history_item->field_value('title'),
	$time->out_string_date,$history_user->out_full_name()? $history_user->out_full_name : $history_item->field_value('modified_by'));
-]
<tr><td>
<A HREF="/hsdb4/content_history/[+ $orig_doc->primary_key +]/[+ $history_item->primary_key +]">
[+ $history_name +]
</A>[$ if ($history_item->field_value('modify_note')) $] - <span style="font-style:italic">[+ $history_item->field_value('modify_note') +]</span> [$ endif $]
</td></tr>
[$ endforeach $]
</table>
[$ else $]
<A HREF="/hsdb4/content_history/[+$orig_doc->primary_key() +]">Return to View History Page</A>
[- $doc = $history_doc->get_content_object; -]
[- $doc->xsl_stylesheet($xsl_dir."/Content/Document.xsl") -]
[- $body = $doc->out_html_body(); -]
[$ if ($doc->error) $]
<div class="error">This document cannot be displayed at this time.  Please email [+ $TUSK::Constants::SupportEmail +] if you have a question.</div>
[-
        use TUSK::ErrorReport ;
        ErrorReport::sendErrorReport($req_rec,{'Msg'=>$doc->error()});
-]
[$ else $]
[- $length = length($body); -]
[$ if ($doc->conversion_status() < 1) $]
<br>
[$ endif $]
[+ $body +]
[$ endif $] [# check for doc error #]
[$ endif $] [# single history record view #]
[$ endif $] [# check for error msg #]
</BODY>
</HTML>
