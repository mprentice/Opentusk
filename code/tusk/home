<%doc>
 Copyright 2012 Tufts University 

 Licensed under the Educational Community License, Version 1.0 (the "License"); 
 you may not use this file except in compliance with the License. 
 You may obtain a copy of the License at 

 http://www.opensource.org/licenses/ecl1.php 

 Unless required by applicable law or agreed to in writing, software 
 distributed under the License is distributed on an "AS IS" BASIS, 
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 See the License for the specific language governing permissions and 
 limitations under the License.
</%doc>
<%attr>
page_header      => '/tmpl/prepend:manage_header_div_layout'
page_footer      => '/tmpl/footer:footer_div_with_school_links'
no_check_path    => 1
top_tab_type     => 'home'
allow_shib       => 1
nostandardheader => 1
body_id          => 'home'
</%attr>

<%once>
use Forum::ForumKey;
use HSDB45::Course;
use HSDB4::DateTime;
use POSIX qw(strftime);
</%once>

<%shared>
my $user = $m->session->{'user'};
my $user_id = $user->primary_key();

my @list_cats = $user->get_list_cats();
my $enum_cat = $user->get_enum_cat(@list_cats);
my $affiliation = $user->affiliation();

my %course_hash;
my @courses = $user->parent_courses();

foreach my $course (@courses){
	if ($course->type() eq 'group'){
		push (@{$course_hash{$course->school()}{"user_groups"}}, $course);
	}
	elsif ($course->type() eq 'committee' || $course->type() eq 'thesis committee') {
		push (@{$course_hash{$course->school()}{"user_committees"}}, $course);
	}
	elsif ($course->type() eq 'community service' or $course->type() eq 'course' or $course->type() eq 'integrated course') {
		if ($course->can_user_edit($user)) {
			push (@{$course_hash{$course->school()}{"admin_courses"}}, $course);
		}
		else {
			push (@{$course_hash{$course->school()}{"auth_courses"}}, $course);
		}
	}  
}

my @current_courses = $user->current_courses( {'only_enrollment' => 1} );
my @user_stud_courses = $user->user_stud_courses(@current_courses);
</%shared>

<%method title>
% return $TUSK::Constants::SiteAbbr ." Home";
</%method>

<%method jsarray>
% return ['jquery/jquery.min.js','home.js'];
</%method>

<%method stylearray>
% return ['/style/style.css'];
</%method>

<%method leftnav>
<%perl>
my %someHash = (
                'component'   => "/tmpl/leftnav/home",
                'show_in_td'  => 0,
               );
return \%someHash;
</%perl>
</%method>

<%perl>
my $counter = 0;
my $upcoming = 0;
my @schools;
</%perl>
<nav class="toptabs">
<ul>
% if (scalar keys %course_hash) {
% 	foreach my $school (keys %course_hash) {
	<li<% ($counter == 0) ? ' class="current"' : ''%>><a href="#schooltab<% $counter %>"><% $TUSK::Constants::Schools{$school}{'DisplayName'} %></a>
%		$upcoming += scalar @{$user->get_important_upcoming_dates($school)};
%		$counter++;
% 	}
%	@schools = keys %course_hash;
% }
% else {
	<li class="current"><a href="#schooltab0"><% $TUSK::Constants::Schools{$user->affiliation()}{'DisplayName'} %></a></li>
%	@schools = ($user->affiliation());
% }
</ul>
</nav>
% $counter = 0;
% my @sorted_meetings = $user->todays_sorted_meetings();
% my $calendar_tab;
% if (scalar @sorted_meetings || $upcoming) {
%	$calendar_tab = 1;
% }

% foreach my $school (@schools) {
% 	my @tabs;
	<div id="schooltab<% $counter %>" class="toptab<% ($counter == 0) ? ' current' : ''%><% ($calendar_tab) ? '' : ' full' %>">
		<div class="tabinner">
			<h1 class="skip"><% $TUSK::Constants::Schools{$school}{'DisplayName'} %></h1>
			<div class="courses tabgroup">
				<nav class="tabs">
					<ul>
% 	if ($course_hash{$school}{"auth_courses"} && scalar @{$course_hash{$school}{"auth_courses"}}) {
%		push @tabs, "auth_courses";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Courses</a></li>
% 	}
% 	if ($course_hash{$school}{"user_groups"} && scalar @{$course_hash{$school}{"user_groups"}}) {
%		push @tabs, "user_groups";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Groups</a></li>
% 	}
% 	if ($course_hash{$school}{"admin_courses"} && scalar @{$course_hash{$school}{"admin_courses"}}) {
%		push @tabs, "admin_courses";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Admin</a></li>
% 	}
% 	if ($course_hash{$school}{"user_committees"} && scalar @{$course_hash{$school}{"user_committees"}}) {
%		push @tabs, "user_committees";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Committees</a></li>
% 	}
					</ul>
				</nav>
				<div class="tabcontainer">
% 	my $tabcounter = 0;
% 	foreach my $tab (@tabs) {
%		if ($course_hash{$school}{$tab} && scalar @{$course_hash{$school}{$tab}}) {
				<section id="schooltab<% $counter %>coursetab<% $tabcounter %>" class="tab<% ($tabcounter == 0) ? ' current' : '' %>">
					<ul>
%			foreach my $course (@{$course_hash{$school}{$tab}}) {
						<li><a href="#"><% $course->out_title() %></a></li>
%			}
					</ul>
				</section>
% 			$tabcounter++;
%		}
% 	}
				</div>
			</div>
%	if ($calendar_tab) {
			<div class="calendar tabgroup">
				<nav class="tabs">
					<ul>
%		if (scalar @sorted_meetings) {
						<li class="current"><a href="#schooltab1calendartab1">Today</a></li>
%		}
%		if (scalar @$upcoming) {
						<li<% (scalar @sorted_meetings) ? '' : ' class="meetings"' %>><a href="#schooltab1calendartab2">To Do</a></li>
%		}
					</ul>
				</nav>
				<div class="tabcontainer">
%		if (scalar @sorted_meetings) {
					<section class="tab current" id="schooltab1calendartab1">
						<h1 class="skip">Calendar</h1>
						<article>
							<time datetime="2012-01-15T08:00:00">8:00am - 9:00am</time>
							<h1><a href="#">Lore ipsum dolor sir amet</a></h1>
							<p>Fusce convallis, quam ac ullamcorper accumsan</p>
						</article>
						<article>
							<time datetime="2012-01-15T10:00:00">10:00am - 11:00am</time>
							<h1><a href="#">Vivamus blandit tellus sit amet</a><span class="mandatory">*</span></h1>
							<p>Nulla scelerisque, leo molestie sagittis dignissim</p>
						</article>
						<article>
							<time datetime="2012-01-17T09:00:00">9:00am - 10:30am</time>
							<h1><a href="#">Ut eget imperdiet est</a></h1>
							<p>Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia</p>
						</article>
					</section>
%		}
%		if (scalar @$upcoming) {
					<section class="tab" id="schooltab1calendartab2">
						<h1 class="skip">To Do</h1>
%			foreach my $meeting (@$upcoming) {
						<article class="todo">
							<time><% $meeting->meeting_date() %></time>
							<h1><a href="#"><% $meeting->title() %></a></h1>
						</article>
%			}
					</section>
%		}
				</div>
			</div>
% 	}
			<div class="personal tabgroup">
				<div class="links">
					<hgroup>
						<h1>School Links</h1>
					</hgroup>
					<div class="tabcontainer">
						<section class="tab">
							<& /tmpl/home:print_school_links, school =>  TUSK::Core::School->new->lookupReturnOne("school_name = '$school'") &>
						</section>
					</div>
				</div>
				<div class="content">
					<nav class="tabs">
						<ul>
							<li class="current"><a href="#schooltab2contenttab1">Recently Viewed</a></li>
							<li><a href="#schooltab2contenttab2">Popular</a></li>
						</ul>
					</nav>
					<div class="tabcontainer">
						<section id="schooltab2contenttab1" class="tab current">
							<h1 class="skip">Recently Viewed</h1>
						</section>
					</div>
				</div>
			</div>
		</div>
		<div class="bottom">
		</div>
	</div>
%	$counter++;
% }


<%doc>
method to print the user's courses on the homepage.
if the user does not have any relevant courses, the section is not printed.
</%doc>
<%method courses>
<%args>
$hp_section
</%args>

% if(defined $enum_cat or scalar @user_stud_courses){

<div class="homeSection">

<div class="toggled">

<& /tmpl/home:print_courses, enum_cat => $enum_cat, user_stud_courses => \@user_stud_courses &>

<a href="/allcourses.htm" class="xsm indented"><strong>Browse All Courses</strong></a>

</div><!-- toggled -->
</div>
% }
</%method>


<%doc>
method to print the homepage course dropdowns for the user's primary affiliation.
</%doc>
<%method school_courses>
<%args>
$hp_section
</%args>
<%perl>
my $school = TUSK::Core::School->new->lookupReturnOne("school_name = '$affiliation'");

my $school_name = "School";

if ($school && $school->getPrimaryKeyID()){
	$school_name = $school->getSchoolDisplay();
}
</%perl>

% if(scalar @list_cats){

<div class="homeSection">

<div class="toggled">

<& /tmpl/home:print_school_courses, list_cats => \@list_cats &>

</div>
</div>
% }
</%method>



<%doc>
method to print the user's discussions
</%doc>
<%method discussions>
<%args>
$hp_section
</%args>

<div class="homeSection">

<div class="toggled">

% my ($new_post_forums, $new_notifications_forums, $link) = Forum::ForumKey::new_post_forums($r, $user, undef, \@current_courses);

<a href="/forum/forum.pl"><strong>All Discussions</strong></a>
% if (defined $new_post_forums && scalar @$new_post_forums){
&nbsp;-&nbsp;<a href="/forum/<% $link %>&amp;redirect_to_home=1"><strong>Mark All Posts as Old</strong></a>
% }

% if (scalar @$new_notifications_forums){
<h4 class="homepageHdr">Notifications:</h4>
<ul class="gNoBullets">
%	foreach my $notification (@$new_notifications_forums){
<li><% $notification->{timeStr} %>: <% $notification->{body} %></li>
%	}
</ul>
% }
<%doc>TUSK changed the evaluated exp for the if statement.  Given a hash to multiple boards, the following creates a flag that helps check for new and unread posts.</%doc>

% my $categoryHeading = 0;
% my $currentCategory = '';

% if (defined $new_post_forums && scalar (@$new_post_forums)){
%	my $first_forum = 1;
%	foreach my $forum_ref (@$new_post_forums){
%		$currentCategory = $forum_ref->{category};
%		if ( $forum_ref->{numNew}){
%			if (!$categoryHeading || ($categoryHeading ne $currentCategory)){
%				$categoryHeading = $currentCategory;
%				unless($first_forum){
</ul>
%				}
<h4 class="homepageHdr"><% $categoryHeading %></h4>
<ul class="gNoBullets">
%			}

<li><a href="/forum/board_show.pl?bid=<% $forum_ref->{bid} %>"><% $forum_ref->{title} %></a>: <% $forum_ref->{numNew} %> new</li>
%		$first_forum = 0;
%		}
%	}
</ul>
% }
% else{
<em class="indented">no new posts</em>
% }

</div>
</div>

</%method>


<%doc>
method to print the user's recently viewed content 
</%doc>
<%method recently_viewed>
<%args>
$hp_section
</%args>
<%perl>
my @recent_content = $user->available_recent_history;
</%perl>

<div class="homeSection">

<div class="toggled">

% if(scalar @recent_content){
<ul class="gNoBullets">
%	foreach my $c (@recent_content){
%		if ($c->is_active()){
<li><a href="<% $c->out_url %>"><% $c->out_label %></a> <em>(<% $c->course->out_label %>)</em></li>
%		}
%	}
</ul>
% }
% else {
<em class="indented">no recently viewed content</em>
% }
</div>
</div>
</%method>


<%doc>
method to print the "school links" for the user's primary affiliation
</%doc>
<%method school_links>
<%args>
$hp_section
</%args>
<%perl>

return if ($m->session->{'user'}->isGhost());

my $school = TUSK::Core::School->new->lookupReturnOne("school_name = '$affiliation'");
return unless defined $school;
</%perl>

<div class="homeSection">

<div class="toggled">

<& /tmpl/home:print_school_links, school => $school &>

</div>
</div>
</%method>


<%doc>
method to print the user's school's popular content 
</%doc>
<%method pop_content>
<%args>
$hp_section
</%args>
<%perl>
my @groups = $user->parent_user_groups;
</%perl>

<div class="homeSection">

<div class="toggled">

% my $hot_content_count = 0;
% foreach my $group (@groups){
%	my @group_content = $group->hot_content();
%	if (scalar @group_content){
<h4 class="homepageHdr"><% $group->out_label() %></h4>
<ul class="gNoBullets">
%		foreach my $content (@group_content){
%			if ($content->is_active()){
<li><a href="/hsdb4/content/<% $content->primary_key %>"><% $content->out_label %></a> <em>(<% $content->course->out_label %>)</em></li>
%				$hot_content_count++;
%			}
%		}
</ul>
%	}
% }
% if (!$hot_content_count){
<em class="indented">no relevant content</em>
% }
</div>
</div>
</%method>

