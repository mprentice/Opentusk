<%doc>
 Copyright 2012 Tufts University 

 Licensed under the Educational Community License, Version 1.0 (the "License"); 
 you may not use this file except in compliance with the License. 
 You may obtain a copy of the License at 

 http://www.opensource.org/licenses/ecl1.php 

 Unless required by applicable law or agreed to in writing, software 
 distributed under the License is distributed on an "AS IS" BASIS, 
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
 See the License for the specific language governing permissions and 
 limitations under the License.
</%doc>
<%attr>
page_header      => '/tmpl/prepend:manage_header_div_layout'
page_footer      => '/tmpl/footer:footer_div_with_school_links'
no_check_path    => 1
top_tab_type     => 'home'
allow_shib       => 1
nostandardheader => 1
body_id          => 'home'
</%attr>

<%once>
use Forum::ForumKey;
use HSDB45::Course;
use HSDB4::DateTime;
use POSIX qw(strftime);
</%once>

<%shared>
my $user = $m->session->{'user'};
my $user_id = $user->primary_key();

my @list_cats = $user->get_list_cats();
my $enum_cat = $user->get_enum_cat(@list_cats);
my $affiliation = $user->affiliation();

my %course_hash;
my @courses = $user->parent_courses();

foreach my $course (@courses){
	if ($course->type() eq 'group'){
		push (@{$course_hash{$course->school()}{"user_groups"}}, $course);
	}
	elsif ($course->type() eq 'committee' || $course->type() eq 'thesis committee') {
		push (@{$course_hash{$course->school()}{"user_committees"}}, $course);
	}
	elsif ($course->type() eq 'community service' or $course->type() eq 'course' or $course->type() eq 'integrated course') {
		push (@{$course_hash{$course->school()}{"admin_courses"}}, $course);
	}  
}

my @current_courses = $user->current_courses( {'only_enrollment' => 1} );
my @user_stud_courses = $user->user_stud_courses(@current_courses);
foreach my $course (@user_stud_courses) {
	push (@{$course_hash{$course->school()}{"stud_courses"}}, $course);
}
</%shared>

<%method title>
% return $TUSK::Constants::SiteAbbr ." Home";
</%method>

<%method jsarray>
% return ['jquery/jquery.min.js','home.js'];
</%method>

<%method stylearray>
% return ['/style/style.css','/style/home.css'];
</%method>

<%method leftnav>
<%perl>
my %someHash = (
                'component'   => "/tmpl/leftnav/home",
                'show_in_td'  => 0,
               );
return \%someHash;
</%perl>
</%method>

<%perl>
my $counter = 0;
my $upcoming = {};
my @schools;
</%perl>
<nav class="toptabs">
<ul>
% if (scalar keys %course_hash) {
% 	foreach my $school (keys %course_hash) {
	<li<% ($counter == 0) ? ' class="current"' : ''%>><a href="#schooltab<% $counter %>"><% $TUSK::Constants::Schools{$school}{'DisplayName'} %></a>
%		my $temp_arrayref = $user->get_important_upcoming_dates_by_school($school);
%		$upcoming->{$school} = [];
%		foreach my $meeting (@$temp_arrayref) {
%			push @{$upcoming->{$school}}, $meeting;
%		}
%		$counter++;
% 	}
%	@schools = keys %course_hash;
% }
% else {
	<li class="current"><a href="#schooltab0"><% $TUSK::Constants::Schools{$user->affiliation()}{'DisplayName'} %></a></li>
%	@schools = ($user->affiliation());
%	$upcoming->{$user->affiliation()} = $user->get_important_upcoming_dates_by_school($user->affiliation());
% }
</ul>
</nav>
% $counter = 0;
% foreach my $school (@schools) {
%	my @sorted_meetings = $user->todays_sorted_meetings();
%	my $calendar_tab;
%	if (scalar @sorted_meetings || scalar @{$upcoming->{$school}}) {
%		$calendar_tab = 1;
%	}
% 	my @tabs;
	<div id="schooltab<% $counter %>" class="toptab<% ($counter == 0) ? ' current' : ''%><% ($calendar_tab) ? '' : ' full' %>">
		<div class="tabinner">
			<h1 class="skip"><% $TUSK::Constants::Schools{$school}{'DisplayName'} %></h1>
			<div class="courses tabgroup">
				<nav class="tabs<% (scalar keys %{$course_hash{$school}} <= 1) ? ' single' : '' %>">
					<ul>
% 	if ($course_hash{$school}{"stud_courses"} && scalar @{$course_hash{$school}{"stud_courses"}}) {
%		push @tabs, "stud_courses";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Courses</a></li>
% 	}
% 	if ($course_hash{$school}{"user_groups"} && scalar @{$course_hash{$school}{"user_groups"}}) {
%		push @tabs, "user_groups";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Groups</a></li>
% 	}
% 	if ($course_hash{$school}{"admin_courses"} && scalar @{$course_hash{$school}{"admin_courses"}}) {
%		push @tabs, "admin_courses";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Admin</a></li>
% 	}
% 	if ($course_hash{$school}{"user_committees"} && scalar @{$course_hash{$school}{"user_committees"}}) {
%		push @tabs, "user_committees";
						<li<% ((scalar @tabs) == 1) ? ' class="current"' : '' %>><a href="#schooltab<% $counter %>coursetab<% (scalar @tabs) - 1 %>">Committees</a></li>
% 	}
%	unless (scalar @tabs) {
						<li class="current"><a href="#schooltab<% $counter %>coursetab0">Courses</a></li>
%	}
					</ul>
				</nav>
				<div class="tabcontainer">
% 	my $tabcounter = 0;
%	unless (scalar @tabs) {
					<section id="schooltab<% $counter %>coursetab0" class="tab current">
						<h1 class="skip">Courses</h1>
					</section>
%	}
% 	foreach my $tab (@tabs) {
%		if ($course_hash{$school}{$tab} && scalar @{$course_hash{$school}{$tab}}) {
				<section id="schooltab<% $counter %>coursetab<% $tabcounter %>" class="tab<% ($tabcounter == 0) ? ' current' : '' %>">
					<ul>
%			foreach my $course (@{$course_hash{$school}{$tab}}) {
						<li><a href="<% ($tab eq "admin_courses") ? "/management/course/display/" : "/view/course/" %><% "$school/" . $course->primary_key() %>"><% $course->out_title() %></a></li>
%			}
					</ul>
				</section>
% 			$tabcounter++;
%		}
% 	}
				</div>
			</div>
%	if ($calendar_tab) {
			<div class="calendar tabgroup">
				<nav class="tabs<% (scalar @sorted_meetings && scalar @{$upcoming->{$school}}) ? '' : ' single' %>">
					<ul>
%		if (scalar @sorted_meetings) {
						<li class="current"><a href="#schooltab<% $counter %>calendartab1">Today</a></li>
%		}
%		if (scalar @{$upcoming->{$school}}) {
						<li<% (scalar @sorted_meetings) ? '' : ' class="current"' %>><a href="#schooltab<% $counter %>calendartab2">To Do</a></li>
%		}
					</ul>
				</nav>
				<div class="tabcontainer">
%		if (scalar @sorted_meetings) {
					<section class="tab current" id="schooltab<% $counter %>calendartab1">
						<h1 class="skip">Today</h1>
%			foreach my $meeting (@sorted_meetings) {
						<article>
							<time><% sprintf ("%s - %s", $meeting->out_starttime->out_string_time_hm, $meeting->out_endtime->out_string_time) %></time>
							<h1><a href="/view/course/<% $school %>/<% $meeting->course_id() %>/schedule/<% $meeting->primary_key() %>"><% $meeting->title() %></a></h1>
							<p><% $meeting->location() %></p>
						</article>
%			}
					</section>
%		}
%		if (scalar @{$upcoming->{$school}}) {
					<section class="tab<% (scalar @sorted_meetings) ? '' : ' current"' %>" id="schooltab<% $counter %>calendartab2">
						<h1 class="skip">To Do</h1>
%			foreach my $meeting (@{$upcoming->{$school}}) {
						<article class="todo">
							<time><% $meeting->{date} %> <strong><% $meeting->{time} %></strong></time>
							<h1><a href="/view/course/<% $school %>/<% $meeting->{course_id} %>/schedule/<% $meeting->{class_meeting_id} %>"><% $meeting->{title} %></a></h1>
						</article>
%			}
					</section>
%		}
				</div>
			</div>
% 	}
			<div class="personal tabgroup">
				<div class="links">
					<hgroup>
						<h1>School Links</h1>
					</hgroup>
					<div class="tabcontainer">
						<section class="tab">
							<div class="scrollcontainer">
								<& /tmpl/home:print_school_links, school =>  TUSK::Core::School->new->lookupReturnOne("school_name = '$school'") &>
							</div>
						</section>
					</div>
				</div>
				<div class="content">
					<nav class="tabs">
						<ul>
							<li class="current"><a href="#schooltab<% $counter %>contenttab1">Recently Viewed</a></li>
							<li><a href="#schooltab<% $counter %>contenttab2">Popular</a></li>
						</ul>
					</nav>
					<div class="tabcontainer">
						<section id="schooltab<% $counter %>contenttab1" class="tab current">
							<h1 class="skip">Recently Viewed</h1>
							<div class="scrollcontainer">
								<& SELF:recently_viewed &>
							</div>
						</section>
						<section id="schooltab<% $counter %>contenttab2" class="tab">
							<h1 class="skip">Popular</h1>
							<div class="scrollcontainer">
								<& SELF:pop_content &>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
		<div class="bottom">
			<a href="/allcourses.htm" class="courses">all &raquo;</a>
%	if ($calendar_tab) {
			<a href="/view/schedule/user/<% $user->uid() %>" class="calendar">all &raquo;</a>
%	}
		</div>
	</div>
%	$counter++;
% }

<%doc>
method to print the homepage course dropdowns for the user's primary affiliation.
</%doc>
<%method school_courses>
<%args>
$hp_section
</%args>
<%perl>
my $school = TUSK::Core::School->new->lookupReturnOne("school_name = '$affiliation'");

my $school_name = "School";

if ($school && $school->getPrimaryKeyID()){
	$school_name = $school->getSchoolDisplay();
}
</%perl>

% if(scalar @list_cats){

<div class="homeSection">

<div class="toggled">

<& /tmpl/home:print_school_courses, list_cats => \@list_cats &>

</div>
</div>
% }
</%method>


<%doc>
method to print the user's recently viewed content 
</%doc>
<%method recently_viewed>
<%perl>
my @recent_content = $user->available_recent_history;
</%perl>
% if(scalar @recent_content){
<ul>
%	foreach my $c (@recent_content){
%		if ($c->is_active()){
<li><a href="<% $c->out_url %>"><% $c->out_label %></a> <em>(<% $c->course->out_label %>)</em></li>
%		}
%	}
</ul>
% }
% else {
<p><em>no recently viewed content</em></p>
% }
</%method>


<%doc>
method to print the "school links" for the user's primary affiliation
</%doc>
<%method school_links>
<%args>
$hp_section
</%args>
<%perl>

return if ($m->session->{'user'}->isGhost());

my $school = TUSK::Core::School->new->lookupReturnOne("school_name = '$affiliation'");
return unless defined $school;
</%perl>

<div class="homeSection">

<div class="toggled">

<& /tmpl/home:print_school_links, school => $school &>

</div>
</div>
</%method>


<%doc>
method to print the user's school's popular content 
</%doc>
<%method pop_content>
<%perl>
my @groups = $user->parent_user_groups;
</%perl>
% my $hot_content_count = 0;
% foreach my $group (@groups){
%	my @group_content = $group->hot_content();
%	if (scalar @group_content){
<ul>
%		foreach my $content (@group_content){
%			if ($content->is_active()){
<li><a href="/hsdb4/content/<% $content->primary_key %>"><% $content->out_label %></a> <em>(<% $content->course->out_label %>)</em></li>
%				$hot_content_count++;
%			}
%		}
</ul>
%	}
% }
% if (!$hot_content_count){
<p><em>no relevant content</em></p>
% }
</%method>

