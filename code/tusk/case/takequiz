<%once>
	use TUSK::Case::LinkCaseReportQuizResult;
	use TUSK::Quiz::Quiz;
	use TUSK::Quiz::Result;
	use TUSK::Case::Case;
</%once>

<%shared>
	my $quiz_previously_completed = 0;
	my ($case_id, $phase_id, $quiz_id, $report_id) = $m->comp("/tmpl/url:get_path_ids");
	my $phase = TUSK::Case::Phase->lookupKey($phase_id);
	my $quiz = TUSK::Quiz::Quiz->lookupKey($quiz_id);
	my $case = TUSK::Case::Case->lookupKey($case_id);
	my $user_id = $m->comp('SELF:user');
	my $preview_text = $m->comp('SELF:get_preview_text', case => $case);
	my $report = $case->getReport();

	my %ARGS = $m->request_args();

	my $quiz_submitted = 0;  
	my $result = TUSK::Quiz::Result::findOpenResult($user_id, $quiz_id);
	my $has_result = $report->getCompletedQuiz($quiz_id);
	if (defined($ARGS{'submit'})){
		if (defined($result)){
			my $quizItemHash = {};
			my $quiz_items = $quiz->getQuizItems();
			foreach my $quiz_item (@{$quiz_items}){
				$quizItemHash->{($quiz_item->getPrimaryKeyID())} = $quiz_item;
			}
			$result->createResponses($user_id, $quizItemHash, \%ARGS);
			$result->setEndDate();
			$result->save({ user => $user_id }); 
			my $link = TUSK::Case::LinkCaseReportQuizResult->new();
			$link->setParentCaseReportID($report_id);
			$link->setChildQuizResultID($result->getPrimaryKeyID());
			$link->save({ user => $user_id });
			$quiz_submitted = 1;
		}
	} 
	if (defined($has_result)){
		$quiz_previously_completed = 1;
		$result = $has_result;
	} elsif (!defined($result)){
		$result = TUSK::Quiz::Result->new();
		$result->setUserID($user_id);
		$result->setQuizID($quiz_id);
		$result->setStartDate();
		$result->save({ user => $user_id });
	} 
</%shared>



<& tmpl/element:transition,args => \%ARGS &>

<& /tmpl/element:table &>

<& tmpl/element:header_bar, label => $quiz->getTitle() . $preview_text &>

% if (!$case->isTest() or (!$quiz_previously_completed and !$quiz_submitted)){
	<tr>
		<td>
			<table>
				<tr>
					</td>
<%perl>
	if ($quiz_submitted or $quiz_previously_completed){
		$m->comp("/quiz/tmpl/quizdisplay:display_responses", quiz => $quiz, result => $result, show_title => 0);
	}
	else {
		$m->comp("/quiz/tmpl/quizdisplay:display_quiz", quiz_id => $quiz_id, show_title => 0);
	}
</%perl>

</td>
</tr>
	<& tmpl/element:divider_bar &>
% }

% if (!$quiz_submitted and !$quiz_previously_completed){
			<& /tmpl/element:save_button, params=>{
					no_cancel_button => 1, 
					one_column => 1, 
					label => 'Submit Quiz',
					name => 'submit',
					td_class => '',
					} &>
% } else {
	<tr>
		<td class="no-button">
			<& tmpl/element:transition_button, no_quiz => 1, no_submit => 1, case => $case, phase => $phase, args => \%ARGS, formname => 'takequiz' &>
			<& /tmpl/wizard:include &>
		</td>
	</tr>
% }
</table>
</form>



<%method jsarray>
%return ['element.js', 'caseshell.js', 'quiz.js'];
</%method>

<%method leftnav>
% return { component=>'/case/tmpl/leftnav/phase', 'phase'=>$phase, 'case'=>$case };
</%method>

<%method title>
% return $quiz->getTitle() . $preview_text;
</%method>

<%method form>
<%perl>
	return $m->scomp('/tmpl/element:form', params => {
						                method 		=> 'POST',
						                name 		=> 'takequiz',
						                onsubmit 	=> (!$quiz_submitted) ? "return check_quiz(this)" : undef,
							});
</%perl>
</%method>

<%method startup>
<%perl>
	if ($quiz_submitted){
		if (!$case->isTest()){
			$m->comp('SELF:set_msg', msg => 'Your quiz has been submitted, please review your answers');
		}
		else{
			$m->comp('SELF:set_msg', msg => 'The quiz has been submitted');
		}
	} 
	elsif ($quiz_previously_completed){
		if (!$case->isTest()){
			$m->comp('SELF:set_msg', msg => 'You have already submitted this quiz.<br/>Your responses are below.');
		}
		else{
			$m->comp('SELF:set_msg', msg => 'You have already submitted this quiz', type => 'errmsg');
		}
	}

</%perl>
</%method>