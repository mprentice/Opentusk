<%once>
	use TUSK::Manage::Course::Students;
</%once>
<%attr>
	show_tp_dropdown_no_cache => 1
	top_tab_type            => 'manage'
	check_cms_permissions	=> 1
    default_path_type	=> 'course'
</%attr>

<& /tmpl/element:form, params => {
	method => 'POST',
	class => 'no-padding',
	onsubmit => "",
	name => 'users' } 

&>

<& /tmpl/element:table, params => { 
	width => "100%",
	cellspacing =>"0",
	cellpadding =>"0" } &>


% if ($is_school_admin ) {
                    <tr> 
                      <td>


<& /tmpl/element:cms_button_row, links => $buttons 
	&>

	</td></tr>
	<tr><td>

% } else {
	<tr>
	<td class="no-button">
% } 

% if (scalar(@{$data->{students}})) {

% my @rows;
% foreach my $i (0..(scalar(@{$data->{students}})-1)) {
% my $usr = $data->{students}->[$i];
% my $site_id;
% if ($usr->aux_info('teaching_site_id')){
%		$site_id = $usr->aux_info('teaching_site_id');
%	}else{
%		$site_id = 0;
%	}
% my $site_name='None';
% if(exists $data->{sites}->{$site_id} ) { 
%		$site_name = $data->{sites}->{$site_id}->field_value('site_name');
% } 
% $rows[$i] = { 
%				'id' => $usr->field_value('user_id'), 
% #				'lastname' => $usr->field_value('lastname'),
% #				'firstname' => $usr->field_value('firstname'),
%				'name' => $usr->field_value('lastname') . ", " . $usr->field_value('firstname'),
%				'teachingsite' => $site_name,
%				'affiliation' => $usr->field_value('affiliation') };
% }

% my $action_cols;
% $action_cols =  [ 	{ 'label' =>'Modify','link' => '/management/course/students/addedit' } ];
% if (!$course->associate_user_group() ) {
%   $action_cols = [ 	{ 'label' =>'Modify','link' => '/management/course/students/addedit' }, { 'label' =>'Delete','link' => '/management/course/students/delete' } ]
% } 


% if ($is_school_admin) {

<& /tmpl/element:object_selection_box, params => { 
	columns => [ 
		{'label' => 'UserID', 'field' => 'id' , width => '15%'},
		{'label' => 'Name', 'field' => 'name', width => '40%'},
		{'label' => 'Affiliation', 'field' => 'affiliation', align=>'center'},
		{'label' => 'Teaching Site', 'field' => 'teachingsite', align=>'center'}, 
	],
	action_columns => $action_cols,
	action_column_align => 'center',
	rows => \@rows,
	type_path => $m->comp("/tmpl/url:get_type_path"),
	name => "people",
} &>

% } else {

<& /tmpl/element:object_selection_box, params => { 

	columns => [ 
		{'label' => 'UserID', 'field' => 'id' , width => '15%'},
		{'label' => 'Name', 'field' => 'name', width => '10%'},
		{'label' => 'Affiliation', 'field' => 'affiliation', align=>'center'},
		{'label' => 'Teaching Site', 'field' => 'teachingsite', align=>'center'}, 
	],
	rows => \@rows,
	type_path => $m->comp("/tmpl/url:get_type_path"),
	name => "people",
} &>


% 		} # END ELSE

% } # END IF data{students}

</td>
</tr>
</table>
</form>

<%init>

	my $selfpath = $m->comp("/tmpl/url:get_full_path");
	my $type_object =  $m->comp("/tmpl/url:get_type_object");
	my $school = $m->comp("/tmpl/url:get_school");
	my $time_period = $m->comp("SELF:get_timeperiod_id");
	my $course = HSDB45::Course->new( _school => $school )->lookup_key( $type_object->course_id );

    my $data =  TUSK::Manage::Course::Students::show_pre_process(1, $type_object->course_id, $school, $time_period);
	my $buttons = [];	
	my $is_school_admin = TUSK::Session::is_school_admin($m->session, $school, $m->session->{'user'});

	if ($is_school_admin) {

		if (!$course->associate_user_group()) {
			push @$buttons, { link_txt    => '/management/course/students/addedit/' . $selfpath,
                           display_txt => 'Add Course Student(s)'
                         };
		}

		push @$buttons, { link_txt    => '/management/course/students/teachingsites/' . $selfpath."/?timeperiod=".$time_period,
				                           display_txt => 'Update All Teaching Sites'
				                         };
	}

</%init>

<%method title>
% return "Manage Course Students";
</%method>

<%method red_header_text>
% return $m->comp("SELF:title");
</%method>







