<%once>
	use HSDB4::SQLRow::Content;
	use TUSK::Application::DeleteContent;
	use URI::Escape;
</%once>

<%attr>
	top_tab_type	=> 'manage'
</%attr>

<%args>
	@content => ()
</%args>

<%shared>
	my @contentObjectArray;
	my $backURL;
</%shared>

<%method startup>
	<%args>
		$args
	</%args>

	<%perl>
		if($args->{goToWhenDone}) {$backURL = $args->{goToWhenDone};} else {$backURL = $ENV{HTTP_REFERER};}
		$backURL =~ s/\?.*$//;
		my @tempContentIDArray;
		if(ref($args->{content}) eq 'ARRAY') {
			foreach my $contentID (@{$args->{content}}) {push @tempContentIDArray, $contentID;}
		} else {
			push @tempContentIDArray, $args->{content};
		}

		my ($rval, $msg);
		if(defined($args->{submit_check}) && defined($args->{form_submit})){
			my $tempObject = $m->comp('/tmpl/url:get_type_object');
			my $lastId = $m->comp('/tmpl/url:get_last_path_id');
			if($lastId && ($tempObject->primary_key() ne $lastId)) {$tempObject = HSDB4::SQLRow::Content->new->lookup_key($lastId);}
			($rval, $msg) = TUSK::Application::DeleteContent::process_delete($args->{removeContent}, $m->session->{user}, $tempObject, \@tempContentIDArray);
			if($rval == 0) {$m->comp('/tmpl/url:redirect', message => $msg, msg_type => 'msg', destination => $args->{goToWhenDone});}
		}


		foreach my $contentID (@tempContentIDArray) {
			my $contentObject = HSDB4::SQLRow::Content->new->lookup_key($contentID);
			if($contentObject->primary_key()) {push @contentObjectArray, $contentObject;}
		}
		if($rval || $msg)                      {$m->comp("SELF:set_msg", msg => $msg, type => 'err');}
		elsif(scalar(@contentObjectArray) > 0) {$m->comp("SELF:set_msg", msg => "Are you sure you want to delete content?", type => 'hintmsg');}
		else                                   {$m->comp("SELF:set_msg", msg => "No content was passed... nothing to delete!", type => 'err');}
	</%perl>
</%method>

<%method title>
%	return "Delete Content";
</%method>

<%method jsarray>
%	return $m->comp("/management/tmpl/content:jsarray");
</%method>

<%method get_nav_bars>
% 	return $m->comp("/management/tmpl/content:get_nav_bars");
</%method>

<%method red_header_text>
%	return "Delete Content";
</%method>


<& /tmpl/element:form, params => { method => 'POST', onsubmit =>'return formedit_submit(this);', name => 'formedit' } &> 
<& /tmpl/wizard:include &>
<& /tmpl/element:table, params => { width => "100%", border =>"0", cellspacing =>"0", cellpadding =>"0" } &> 

<%perl>
	my $alsoLinkedFrom = '';
	my %linkedLocations;
	my $contentToRemove = '';
	foreach my $contentObject (@contentObjectArray) {
		$contentToRemove.= $contentObject->title() . " (" . $contentObject->primary_key() . ")<input type=\"hidden\" name=\"content\" value=\"" . $contentObject->primary_key() . "\"><br>";
		if($contentObject and $contentObject->primary_key()) {
			foreach my $contentParent ($contentObject->other_parents()) {
				my $link = '';
				if($contentParent->isa('HSDB4::SQLRow::Content')) {
					$link = "<a href=\"/management/folders/course/".$contentParent->school()."/".$contentParent->field_value('course_id')."/".$contentParent->primary_key."\">".$contentParent->field_value('title')."</a>";
				} elsif($contentParent->isa('HSDB45::Course')) {
					$link = "<a href=\"/management/course/display/" . $contentParent->school() . "/" . $contentParent->course_id() . "\">" . $contentParent->out_label() . "</a>";
				}
				$linkedLocations{$contentParent->primary_key} = $link;
			}
		}
	}
	unless($contentToRemove) {$contentToRemove = 'None';}
	foreach (sort keys %linkedLocations) { $alsoLinkedFrom .= $linkedLocations{$_} . "<br>\n"; }
	unless($alsoLinkedFrom) {$alsoLinkedFrom = 'Nothing';}
</%perl>

<& /tmpl/element:hidden_form_element, params =>{ name=> 'goToWhenDone', value => $backURL } &>
<& /tmpl/element:field_display, params =>{ label => 'Content To Remove', value => $contentToRemove } &>
<& /tmpl/element:field_display, params=>{ label => 'Linked From', value=>$alsoLinkedFrom } &>
% if(scalar(@contentObjectArray) > 0) {
<& /tmpl/element:flexible_tr, params=>{ label => 'What do you want to do?' } &>
	<table width="100%" cellspacing="0" class="tusk">
		<tr>
			<td class="layers-left" width="10"> <input name="removeContent" type="radio" value="0" checked></td>
			<td class="layers-left">
				<b>Remove Content from This Folder Only</b> (Recommended)
				<span class="navsm"><br>
					Content will still be accessible from other folders and courses linking to it. <br>
              				You will still be able to reuse this content in other folders and courses.<br>
					If you are an author or editor of this content, and it no longer appears anywhere else, you will be able to use the search to locate it.
				</span>
			</td>
		</tr>
		<tr>
			<td class="layers-left" width="10" > <input type="radio" name="removeContent" value="1"></td>
			<td class="layers-left">
				<b>Delete Content</b><br>
				<span class="navsm">
					Content will be completely removed and unavailable. <br>
					ONLY authors and editors of content have this option, and ONLY IF it is not linked from another folder or course.
				</span>
			</td>
		</tr>
	</table>
</td></tr>
% $backURL .= "?msg=" . uri_escape("Delete Canceled");
<& /tmpl/element:save_button, params=>{label=>'Remove Content', name=>'form_submit', cancel_onclick=>"go_back('$backURL');" } &>
% }
</table>


