<%perl>
  use HSDB4::SQLRow::User;
  use HSDB4::SQLRow::PersonalContent;
  use TUSK::FlashCard;
  use HSDB4::SQLRow::Content;
  use HSDB4::Constants;
  use TUSK::Constants;
  use Data::Dumper;
</%perl>

<%attr>
	page_header	  => '/tmpl/prepend:manage_header_div_layout'
	page_footer	  => '/tmpl/footer:footer_div_with_tufts_links'
	no_check_path	=> 1
</%attr>

<%method jsarray>
% return ['flashcards.js'];
</%method>

<%method red_header_class>
%	return 'blueHeaderBar';
</%method>

<%method red_header_text>

% return $m->comp( "SELF:title" );
</%method>

<%method title>
%   my $deck = HSDB4::SQLRow::PersonalContent->new->lookup_key($m->comp("/tmpl/url:get_last_path_id"));
%   
%	return $TUSK::Constants::SiteAbbr . " Flash Card Deck: " . $deck->out_label;
</%method>

<%init>
my $pcId = $m->comp("/tmpl/url:get_last_path_id");
my $fcards;
my $indx=0;
my $hascards=1;

my $qStr = "parent_personal_content_id = ".$pcId." order by content_id ASC";
$fcards =  TUSK::FlashCard->lookup($qStr);

# if there are cards in this deck, get started
if ( scalar(@$fcards) > 0 )
{


	if ( exists($ARGS{'card_index'}) ) {
		$fcards= ();
		$indx = $ARGS{'card_index'};

		#load fcards from hidden form data
		my $i=0;
		my $str = "c$i";
		while( exists($ARGS{$str}) ){
			@$fcards[$i] = TUSK::FlashCard->lookupReturnOne("flash_card_id =".$ARGS{$str});	
			$i++;
			$str="c$i";
		}
   
		if ( $ARGS{'submit'} eq 'Previous Card' && ($indx > 0) ) { 
	
		 	$indx--;
		}
		elsif ( $ARGS{'submit'} eq 'Next Card' &&  ($indx < (scalar(@$fcards)-1) ) ) {
	
			$indx++;
		}

    
	}
	else {
		#if card index doesnt exist, this is start of deck viewing
		#so need to perform fisher-yates shuffle

		my $qStr = "parent_personal_content_id = ".$pcId." order by content_id ASC";
		$fcards =  TUSK::FlashCard->lookup($qStr);
		my $i;
   		for ($i = @$fcards; --$i; ) {
   		   	 my $j = int rand ($i+1);
    	     next if $i == $j;
    	     @$fcards[$i,$j] = @$fcards[$j,$i];
    	}
    
	}

	#if we've done the entire deck, start over
	if ($indx > ( scalar(@$fcards) -1 ) ){

		$indx=0;
	}

} ### end if scalar(fcards) > 0
else { 
	# there are no cards, set flag
	$hascards = 0;
}

</%init>


% if ($hascards ) {  

<& /tmpl/element:form, params => {
				method => 'POST',
				onsubmit =>'return event_submit(this)',
				name => 'savecard' } &>


<input type="hidden" value="<% $indx %>" name="card_index" />
% my $k = 0;
% foreach my $crd (@$fcards){

<input type="hidden" value="<% $crd->getFlashCardID %>" name="c<% $k %>" />
% $k++; } # end foreach

 
<div style="border-left: 3px solid rgb(49, 100, 155); border-right: 3px solid rgb(49, 100, 155); border-bottom: 3px solid rgb(49, 100, 155); margin: 0px; padding-top: 0px; background-image: url(/graphics/case/sb_BackgroundTile.gif); z-index: 1;">


<br><br>
<table>
<tr><td></td><td align="left">


% my $cntnt = HSDB4::SQLRow::Content->new()->lookup_key(@$fcards[$indx]->getContentID);
% my $fczoom;
% if (@$fcards[$indx]->getZoom()) { $fczoom = @$fcards[$indx]->getZoom(); } 
% else { $fczoom="orig"; }



<div id="overlayimg" style="display:none;">

% if ( @$fcards[$indx]->getContentID ) {
<input type="hidden"  name="zoom" value="<% $fczoom %>" id="zoom" />
% my $imageDir = "/graphics";
<a class="toggleImgCntrl nodots subHead1" onclick="toggle_visibility('zoomdiv')" href="javascript:;">Image Zoom</a> 
<div id="zoomdiv" name="zoomdiv" style="visibility:hidden;">

<img id="medium" class="zoomBtn" onClick="javascript:swapImg('medium',this,'mainImg');" src="<% $imageDir %>/zoommedium.gif"  title="Zoom Medium" alt="Zoom Medium">

<img id="large" class="zoomBtn" onClick="javascript:swapImg('large',this,'mainImg');" src="<% $imageDir %>/zoomlarge.gif"  title="Zoom Large" alt="Zoom Large">
<img id="xlarge" class="zoomBtn" onClick="javascript:swapImg('xlarge',this,'mainImg');" src="<% $imageDir %>/zoomxlarge.gif"  title="Zoom XLarge" alt="Zoom XLarge">
<img id="original" class="zoomBtn" onClick="javascript:swapImg('orig',this,'mainImg');" src="<% $imageDir %>/zoomorig.gif"  title="Zoom Original" alt="Zoom Original">
</div>

% if ($cntnt->overlay_data) {
  <img class="mainImg" id="mainImg"src="/overlay/orig/<% @$fcards[$indx]->getContentID %>"/> 
% } else { 
<img class="mainImg" id="mainImg" src="/<%$fczoom %>/<% @$fcards[$indx]->getContentID %>"/>
% }
% }
</div>



<div id="regimg" >
% if ( @$fcards[$indx]->getContentID ) {
% my $imageDir = "/graphics";
<a class="toggleImgCntrl nodots subHead1" onclick="toggle_visibility('zoomdiv1')" href="javascript:;">Image Zoom</a> 
<div id="zoomdiv1" name="zoomdiv1" style="visibility:hidden;">

<img id="medium" class="zoomBtn" onClick="javascript:swapImg('medium',this,'mainImg1');" src="<% $imageDir %>/zoommedium.gif"  title="Zoom Medium" alt="Zoom Medium">

<img id="large" class="zoomBtn" onClick="javascript:swapImg('large',this,'mainImg1');" src="<% $imageDir %>/zoomlarge.gif"  title="Zoom Large" alt="Zoom Large">
<img id="xlarge" class="zoomBtn" onClick="javascript:swapImg('xlarge',this,'mainImg1');" src="<% $imageDir %>/zoomxlarge.gif"  title="Zoom XLarge" alt="Zoom XLarge">
<img id="original" class="zoomBtn" onClick="javascript:swapImg('orig',this,'mainImg1');" src="<% $imageDir %>/zoomorig.gif"  title="Zoom Original" alt="Zoom Original">
</div>

  <img class="mainImg1" id="mainImg1" src="/<%$fczoom %>/<% @$fcards[$indx]->getContentID %>"/>
%    } #end if has contentID
</div>

  

</td></tr>

<tr>
% if ( @$fcards[$indx]->getQuestion() ) {
<td align="right"><h2>Question:</h2></td> 
<td>
<textarea disabled name="question" cols="100" rows="5" > <% @$fcards[$indx]->getQuestion() %> </textarea>
</td>
% }
</tr>

<tr><td align="right"> 

<!-- toggle -->
<div id="showDiv" style="visibility:visible;" >
<h2>
<input type="button" class="formButton" onclick="javascript:toggle_visibility('answerDiv');toggle_display('overlayimg');toggle_display('regimg');toggle_button('mybtn');" id="mybtn" style="width:125px;" value="Show Answer"/>

</h2> 
</div>
<!-- toggle -->

</td>

<td>
<div id="answerDiv" style="visibility:hidden">

<textarea disabled  name="answer" cols="100" rows="5" > <% @$fcards[$indx]->getAnswer() %> </textarea>

</div>
</td></tr>
<tr><td></td><td>
% if ( ($indx < (scalar(@$fcards)-1) ) ) {
<input type="submit" name="submit" value="Next Card" class="formbutton">
% }
% if ( ($indx > 0) ) {
<input type="submit" name="submit" value="Previous Card" class="formbutton">
% }
<input type="reset" style="" value="Back to my Flash Card Decks" id="cancel" name="cancel" onclick="go_back('/management/content/flashcard');" class="formbutton"/></td>
</td></tr>

 </table>


</form>
<br><br><br>
</div>

% } else { # if there are no cards
<br><br>
<h2> There are no cards in this deck </h2>
<br><br>
<input type="reset" style="" value="Back to my Flash Card Decks" id="cancel" name="cancel" onclick="go_back('/management/content/flashcard');" class="formbutton"/>
% } 