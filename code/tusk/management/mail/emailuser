<%once>
	use TUSK::Email::Template;
	use TUSK::Manage::Email;
	use HSDB4::DateTime;
</%once>

<%attr>
no_header=>1
page_footer=>0
</%attr>

<%shared>
	my $course = $m->comp("/tmpl/url:get_type_object");
	my $type_path = $m->comp("/tmpl/url:get_type_path");
	my $args = $m->request_args();
	my $author_user_id = $m->session->{'user'}->user_id();
	my $body = $args->{body};
	my $req;
	$req->{course} = $course;
    $req->{user} = $m->session->{'user'};
	my $recipient = HSDB4::SQLRow::User->new()->lookup_key($args->{'recipient'});
</%shared>

<& /tmpl/element:table, params => { id => 'pExpContent' } &>
	<tr>
		<td><img id="pExpLogo" src="/graphics/logosm.gif" alt="TUSK: Tufts University Sciences Knowledgebase" width="255" height="65" /></td>
	</tr>
	<tr>
		<td style="padding-left:5px;">


% if (defined $args->{submit_check}) {
	<& SELF:emailConfirm &>
% } else {
	<& SELF:emailForm &>
% }

		</td>
	</tr>
</table>

<%method startup>
<%args>
	$args
</%args>
<%perl>
	$m->comp('PARENT:startup', args => $args);

	if (defined $args->{submit_check}) {
		$m->comp('SELF:emailSend');
	} else {
		my @msgs = ();
		if (@msgs) {
			$m->comp('SELF:set_msg', type => 'err', msg => join("<br/>\n", @msgs));
		}
	}
</%perl>
</%method>


<%method emailSend>
<%perl>
    my $data = TUSK::Manage::Email::email_process($req, $args) if $args->{action};

 	if (defined $data) {
		$m->comp('SELF:set_msg', 
	 			type 	=> 'msg', 
				msg 	=> 'You have successfully sent the email.' );
	} else {
		$m->comp('SELF:set_msg', 
				type 	=> 'errmsg', 
				msg 	=> 'There is a problem sending the email.' );
	}
</%perl>
</%method>

<%method emailConfirm>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr> 
      <td class="labelgray">To:</td>
      <td class="cell-left"><% $recipient->out_full_name() %> (<% $recipient->email() %>)</td>
      </tr>
      <tr> 
      <td class="labelgray">From:</td>
      <td class="cell-left"><% $req->{user}->out_full_name() %> (<% $req->{user}->email() %>)</td>
      </tr>
      <tr> 
      <td class="labelgray">Subject:</td>
      <td class="cell-left"><% $args->{subject} %></td>
      </tr>
      <tr> 
      <td class="labelgray">Message:</td>
      <td class="cell-left"><% $body %></td>
      </tr>
      <tr> 
      <td class="labelgray">Delivery Status:</td>
      <td class="cell-left"><% $args->{msg} %></td>
      </tr>
      <tr> 
      <td>&nbsp;</td>
      <td class="cell-left"><& /tmpl/element:close_window_button &></td>
      </tr>
</table>
</%method>

<%method getEmailTemplate>
<%args>

</%args>
<%perl>
	my $emailTmpl = TUSK::Email::Template->new();
	$emailTmpl->setFieldValues({
		subject => $args->{'subject'},
		body 	=> $args->{'body'} });
	return $emailTmpl;
</%perl>

</%method>

<%method emailForm>
%   my $email_tmpl = $m->comp("SELF:getEmailTemplate");
<& /tmpl/element:form, params => { method => 'POST',
	name => 'emailform',
	onsubmit => 'return 1;' } &>

<& /tmpl/element:table, params => { width => "100%",
	border =>"0",
	cellspacing =>"0",
	cellpadding =>"0" } &>

<& /tmpl/element:field_display, params =>{ label => 'To:',
	name => 'to',
	value => $recipient->out_full_name() . ' (' . $recipient->email() . ')' } &>

<& /tmpl/element:field_display, params =>{ label => 'From:',
	name => 'from_name',
	value => $m->session->{'user'}->out_full_name() . ' (' . $m->session->{'user'}->email() . ')' } &>

<& /tmpl/element:textbox, params =>{ label => 'Subject:',
	name => 'subject',
	value => $email_tmpl->getSubject(),
	size => 70,
	length => 255 } &>

<& /tmpl/element:textarea, params =>{ label => 'Message:',
	name => 'body',
	value => $email_tmpl->getBody(),
	cols =>"70",
	rows =>"7",  } &>

<& /tmpl/element:save_button, params=>{
		label=>'Send Email',
		no_cancel_button=>'1',
		close_window_button=>'1',
		name=>'action'} &>        


</table>
<& /tmpl/element:hidden_form_element, params => {name => 'email_list', value => '1'} &>
<& /tmpl/element:hidden_form_element, params => {name => 'from', value => $author_user_id} &>
<& /tmpl/element:hidden_form_element, params => {name => 'to', value => $args->{'recipient'}} &>

</form>
</%method>



<%method getCurrentDateTime>
%	my $date = HSDB4::DateTime->new()->in_apache_timestamp(scalar localtime);
% 	my $current_datetime = $date->out_mysql_timestamp();
% 	$current_datetime =~ s/:\d\d$//;
%	return $current_datetime;
</%method>


<%method title>
% 	return "Email Student";
</%method>


<%method jsarray>
% 	return ['formbuilder.js'];
</%method>


