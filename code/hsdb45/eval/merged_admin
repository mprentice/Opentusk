[!
    use Apache::Constants (q/:common/);
    use HSDB4::Constants;
    use HSDB45::UserGroup;
    use HSDB45::Eval::MergedResults;
!]

[$ sub access_denied $]
Did you forget to <a href="/">log in</a>, or are you somewhere you shouldn't be?
[$ endsub $]

[-
    @months = qw/Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec/;
    $escmode = 0;
    $embperldir=$req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});

    # Import the style sheet
    Execute ("$embperldir/hsdb4-style.css");

    ($school) = $req_rec->path_info() =~ /^\/([^\/]*)/;
    ($first_letter) = ($school =~ /(^.)/);
    $first_letter = uc($first_letter);
    $school =~ s/^./$first_letter/;
-]
<head>
<title>Merged Eval Scoreboard</title>
</head>
<html>
<body>

[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/userbox.html")) -]

[$ if !defined(HSDB4::Constants::code_by_school($school)) $]
[-
foreach $school (HSDB4::Constants::eval_schools) {
     my $group = HSDB45::UserGroup->new(_school => $school, _id => HSDB4::Constants::get_eval_admin_group($school)); 
     push (@eval_admin_groups,$group) if (defined $group && $group->primary_key && $group->contains_user($req_rec->connection()->user()));
}
-]

<ul>
[$ foreach $group (@eval_admin_groups) $]
<li><a href="/hsdb45/eval/merged_admin/[+ $group->school +]">[+ $group->school +]</a></li>
[$ endforeach $]
</ul>

[$ if (!@eval_admin_groups) $]
	[- access_denied -]
[$ endif $]
[- 
    Execute($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html"));
    exit();
-]
[$ endif $]


[-
    my $user_name = $req_rec->connection()->user();
    my $group_id = HSDB4::Constants::get_eval_admin_group($school);
    my $user_group = HSDB45::UserGroup->new(_school => $school, _id => $group_id);
    unless ($user_group->contains_user($user_name)) {
        access_denied();
	Execute($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html"));
	exit;
    }
    my $merged_eval = HSDB45::Eval::MergedResults->new(_school=>$school);
    our @evals = $merged_eval->lookup_all();
-]

[$ sub yearline $]
[- $this_year = shift; 
   return unless $past_years{$this_year} -]
<tr>
<td><b>[+ $this_year +]</b> ([+ $past_years{$this_year} +])</td>
[$ foreach $i (1..12) $]
  [$ if ($past_months{"$this_year\-$i"}) $]
    <td><a href="[- uri_flag ($req_rec->uri, 'past', "$this_year\-$i") -]">[+ $past_months{"$this_year\-$i"} +]</a></td>
  [$ else $]
    <td>--</td>
  [$ endif $]
[$ endforeach $]
</tr>
[$ endsub $]

[$ sub scoreboard $]
<table width="100%" cellpadding="0" cellspacing="0">
<tr>
    <td><b>ID</b></td>
    <td><b>Title</b></td>
    <td><b>Edit</b></td>
    <td><b>Report</b></td>
    <td><b>Export</b></td>
</tr>
[- $bg = 0 -]
[$ foreach $eval (@evals) $]
[$ if $bg $]
<tr bgcolor="#dddddd">
[$ else $]
<tr>
[$ endif $]
[- $bg = !$bg -]
    <td width="4%">[+ $eval->field_value('merged_eval_results_id') +]</td>
    <td>[+ $eval->field_value('title') +]</td>
    <td width="5%"><a href="/protected/merged_eval_edit/[+$school+]/[+$eval->primary_key()+]">Edit</a></td>
    <td width="7%"><a href="/eval/merged_report/[+ $school +]/[+ $eval->primary_key +]">Report</a></td>
    <td width="5%"><a href="/hsdb45/eval/export/[+ $school +]/[+ $eval->primary_key +]?MERGED=1">Export</a></td>
</tr>
[$ endforeach $]
</table>
[$ endsub $]

<h2 class="title">[+ $school +] Scoreboard</h2>
<br>
<a href="/protected/eval/administrator/show/[+$school+]">Manage Evaluations</a>
<br>
<br>
<h3 class="title">Create Merged Results Evaluation</h3>
<br>
<input type="button" value="Create new Merged Evalulation" 
onclick="window.location='/protected/merged_eval_edit/[+$school+]/0';">
<br><br>
<h3 class="title">All Merged Results Evaluation</h3>
<br>
[- scoreboard(@evals) -]

<hr />

[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html")) -]

</body>
</html>
