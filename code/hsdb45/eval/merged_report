[! use HSDB45::Eval::MergedResults;
   use HSDB45::Eval::MergedResults::Formatter;
   use Apache::Cookie;
   use Apache::Constants qw (NOT_FOUND);
!]
[- 
    $escmode=0;
    $embperldir = $req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});

    if($req_rec->path_info() =~ /\/(.+)\/(.+)\/(.+)/) {
      $merged_eval_results = HSDB45::Eval::MergedResults->new(_school => $1, _id => $2);
      $filter = 'filtered_';
      $filter_id = $3;
    }
    else {
      $merged_eval_results = HSDB45::Eval::MergedResults->lookup_path( $req_rec->path_info() );
      $filter = '';
      $filter_id = '';
    }

    $eval = $merged_eval_results->parent_eval();

    # Get the authenticated user
    $username = $req_rec->connection->user;
    $user = HSDB4::SQLRow::User->new ()->lookup_key ($username);
    unless ($user->primary_key and $eval->admin_group()->contains_user($user)) {
	$req_rec->status (NOT_FOUND);
	return;
    }

    if(scalar($eval->users())) {
	my @atts = ("HOST" => $req_rec->header_in("Host"), 
		"SVGURL" => "/mergedevalgraph",
		"MERGED_ID" => $merged_eval_results->primary_key(),
 	        "FILTER" => $filter,
		"FILTER_ID" => $filter_id,
		"COMPLETIONS" => 0,
		"HIDEGROUPBY" => $fdat{'HIDEGROUPBY' } ? 1 : 0);

	$formatter = HSDB45::Eval::MergedResults::Formatter->new($merged_eval_results);
        $results_string = HSDB45::StyleSheet::apply_global_stylesheet($ENV{XSL_ROOT} . "/Eval/eval_results.xsl",
						           $formatter->get_xml_text(),
                                                           @atts);
    }
    else {
        $results_string = '\<b>No Results Available\</b>';
    }
-]

<html>
<head>
<title>TUSK Eval Report: [+ $eval->out_label +]</title>
<link rel="stylesheet" type="text/css" href="/style/eval.css" title="HSDBEval"/>
</head>
<body>

[- head_graphics ($merged_eval_results->field_value('title')) -]
<img src="/icons/transdot.gif" width=1 height=1>
<hr>

[+ $results_string +]

</body>
</html>
