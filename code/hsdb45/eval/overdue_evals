[!
    use Apache::Constants (q/:common/);
    use HSDB4::Constants;
    use HSDB4::SQLRow::User;
    use HSDB45::UserGroup;
    use HSDB45::Eval;
!]

[$ sub access_denied $]
Did you forget to <a href="/">log in</a>, or are you somewhere you shouldn't be?
[$ endsub $]
<html>
<head>
[-
    $escmode = 0;
    $embperldir=$req_rec->server_root_relative($ENV{EMBPERL_LIB});
    Execute ({inputfile => "$embperldir/hsdblib.html", import => 1});

    # Import the style sheet
    Execute ("$embperldir/hsdb4-style.css");

    ($school, $user_group_id) = $req_rec->path_info() =~ /^\/([^\/]*)\/(\d+)/;
    if (!defined($user_group_id)){
	    ($school, $user_group_id) = $req_rec->path_info() =~ /^\/([^\/]*)/;
    }
    if (!defined($school)){
	$msg = "Please use the proper URL to access this page";
    }
-]
<title>[+ $school +] Overdue Evals</title>
</head>
<body>


[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/userbox.html")) -]

[-
    my $user_name = $req_rec->connection()->user();
    my $group_id = HSDB4::Constants::get_eval_admin_group($school);
    our $admin_user_group = HSDB45::UserGroup->new(_school => $school, _id => $group_id);
    unless ($admin_user_group->contains_user($user_name)) {
        access_denadmin_ied();
	Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html"));
	exit;
    }
    $admin_user = HSDB4::SQLRow::User->new->lookup_key($user_name);
-]

<h2 class="title">[+ $school +] Overdue Evals</h2>

<a href="/protected/eval/administrator/show/[+ $school +]">Manage Evaluations</A><br>

[$ if ($msg) $]
<div class="error">[+ $msg +]</div>
[$ endif $]
[$ if ($user_group_id) $]
<a href="/hsdb45/eval/overdue_evals/[+ $school +]">Choose another User Group</A>
[# user group already selected #]
[- 
	$ug = HSDB45::UserGroup->new(_school=>$school,_id=>$user_group_id); 
	if (!defined($ug->primary_key())){
		$msg = "That is an invalid user group id";
	} else {
		@users = $ug->ordered_child_users();
		@users = grep {!$admin_user_group->contains_user($_)} @users;
	}
-]
<ul>
[$ foreach $user (@users) $]
<li>[+ $user->out_lastfirst_name +]</li>
[- @evals = $user->overdue_evals(); -]
	<ol>
[$ foreach $eval (@evals) $]
		<li>[+ $eval->out_label +]</li>	
[$ endforeach $]
	</ol>
[$ endforeach $]
</ul>
[$ else $]
[-
	@ugs =  HSDB45::UserGroup->new( _school => $school )->lookup_conditions("sub_group='No'", "order by upper(label)");
	@ugs = grep { $_->has_evals } @ugs;
-]
<ul>
[$ foreach $user_group (@ugs) $]
<li><a href="[+ $school +]/[+ $user_group->primary_key ()+]">[+ $user_group->out_label +]</a></li>
[$ endforeach $]
</ul>
[$ endif $]

[$ if ($msg) $]
<div class="error">[+ $msg +]</div>
[$ endif $]


[- Execute ($req_rec->server_root_relative("$ENV{EMBPERL_LIB}/footer_links.html")) -]

</body>
</html>
