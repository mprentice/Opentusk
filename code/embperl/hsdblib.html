[- use TUSK::Constants; -]

[$ sub url $]
  [- ($url) = shift -] 
  <A HREF="[+ $url +]">[+ $url +]</A> 
[$ endsub $]

[$ sub rep_quot $][- ($reptext) = shift; $reptext =~ s/([\W])/sprintf("&#%d;",ord($1))/eg; -][+ $reptext +][$ endsub $]

[$ sub browser_alert $]
[- $bversion = $req_rec->header_in("User-Agent");-]
[$ if (($bversion =~ /Mac/) && ($bversion =~ /MSIE/)) $]
An Internet Explorer bug on Macintosh computers causes problems logging into the HSDB. Netscape version 4.76 and higher are recommended.<BR>
[$ endif $]
[$ endsub $]

[$ sub email $]
  [- $email = shift -] 
  <A HREF="mailto:[+ $email +]">[+ $email +]</A>
[$ endsub $]

[$ sub uri_flag $]
[- $this_uri = shift;
   $flag = shift;
   $val = shift;
   $val ||= 0;

   # Get the args, and set the flag
   %qry = $req_rec->args;
   $qry{$flag} = $val;
   # Reform the query string
   $qry = join ('&', map { "$_=$qry{$_}" } grep { defined $qry{$_} } keys %qry);
   # And tack it onto the URI
   $this_uri .= "?$qry" if $qry;
-]
[+ $this_uri +]
[$ endsub $]

[$ sub uri_flag_no_args $]
[- $this_uri = shift;
   $flag = shift;
   $val = shift;
   $val ||= 0;

   # Get set the flag
   $qry{$flag} = $val;
   # Reform the query string
   $qry = join ('&', map { "$_=$qry{$_}" } grep { defined $qry{$_} } keys %qry);
   # And tack it onto the URI
   $this_uri .= "?$qry" if $qry;
-]
[+ $this_uri +]
[$ endsub $]

[$ sub head_graphics $]
[- $title = shift; 
   $time = HSDB4::DateTime->new()->out_unix_time; -]
<TABLE class="wide" CELLPADDING=0 CELLSPACING=0 BORDER=0>
<TR><TD><A HREF="/home?[+ $time +]"><IMG SRC="/graphics/logo.gif" BORDER=0 ALT="[+ $TUSK::Constants::SiteAbbr +]" ALIGN="LEFT" width="350" height="90"><!-- Script Running On: [+ $ENV{HOSTNAME} +] under: [+ $$ +] !--></A></TD>
<TD VALIGN="BOTTOM"><H2 class="title">[+$title+]</H2></TD></TR></TABLE>
[$ endsub $]

[$ sub cms_head_graphics $]
[- $title = shift; 
   $time = HSDB4::DateTime->new()->out_unix_time; -]
<TABLE WIDTH=100% CLASS="wide" CELLPADDING=0 CELLSPACING=0 BORDER=0>
<TR><TD><A HREF="/home?[+ $time +]"><IMG SRC="/graphics/logo.gif" BORDER=0 ALT="[+ $TUSK::Constants::SiteAbbr +]" ALIGN="bottom" width="350" height="90"></A></TD>
<TD VALIGN="BOTTOM"><H2 CLASS="title">[+$title+]</H2></TD></TR></TABLE>
[$ endsub $]

[$ sub hint_text $]
[- $text = shift; -]
    [$ if ($text !~ /^$/) $]
        <FONT SIZE=2><I>([+ $text +])</I></FONT></TD>
    [$ endif $]
[$ endsub $]

[$ sub db_form $]
    	<TR>
		<TD colspan="2"><div class="title">Database Information:</div></td>
	</TR>
	[- form_element_text("Password","password",0,0,"",1,$fdat{'password'}) -]
[$ endsub $]

[$ sub collection_form $]
   [- $user = shift; -]
   <TR>
	<TD colspan="2"><div class="title">Collection Information:</div></td>
   </TR>
   	<TR>
		<TD ALIGN=RIGHT><B>Collection Display Options:</B></TD>
		<TD>
		        [- form_element_radio("Show","show",1,1) -]
			[- form_element_radio("Hide","show",0) -]
		</TD>
	</TR>
    [- form_element_text("Collection Title","title",50) -]
    <TR><TD ALIGN=RIGHT><B>Author ID:</B></TD>
    <TD><INPUT TYPE="TEXT" NAME="author_id" VALUE="[+ $user->preference('image_upload_author_id') +]"> [- user_find_link -]</TD></TR>
    [- systems_form($user) -]
    [- form_element_text("Copyright","copyright",50,0,"Copyright 2001, Jane Doe, MD., Ph.D.") -]
    [- $hint_text = "Start your sort order with 10, or if there 
					are existing collections, <BR>continue with increments of 10. 
					This leaves room to insert files later.";
    form_element_text("Collection Sort Order","sort_order",5,0,$hint_text) -]
[$ endsub $]

[$ sub out_course_content_form $]
   [# this sub takes a course object and type array and returns a dropdown with a list of the course with 0 value, and it's content with content_id values #]
   [- $course = shift; 
      @types = @_;
      if (@types) {
          $type_cond = "type in ('".join("','",@types)."')";
      }
      @content = HSDB4::SQLRow::Content->new->lookup_conditions("course_id=".$course->primary_key,$type_cond,"order by title");
   -]
   <select name="content_id">
   <option value="0"></option>
   <option value="0">Course</option>
   <option value="0">-----------------------------------</option>
   <option value="0">[+ $course->out_label+]</option>
   <option value="0"></option>
   [$ if (@content )$]
   <option value="0">Collection</option>
   <option value="0">-----------------------------------</option>
   [$ foreach $content (@content) $]
       [$ if ($content->out_label !~ /^$/) $]
       <option value="[+ $content->primary_key +]">[+ $content->out_label +]</option>
       [$ endif $]
   [$ endforeach $]
   [$ endif $]
   </select>
[$ endsub $]

[$ sub form_element_text $]
    [# this sub takes a title, name, size, maxlength, and hint text and creates a table row (2 columns) with text input area #]
    [- $title = shift;
       $name = shift;
       $size = shift;
       $maxlength = shift;
       $hint_text = shift;
       $password = shift;
       $value = shift;
       $type = "TEXT";

       if ($size > 0) {
           $size = " SIZE=\"".$size."\"";
       }
       else {
           $size = "";
       }
       if ($maxlength > 0) {
           $maxlength = " MAXLENGTH=\"".$maxlength."\"";
       }
       else {
           $maxlength = "";
       }
       if ($hint_text !~ /^$/) {
           $hint_text = "<BR>".$hint_text;
       }
       if ($password > 0) {
           $type = "PASSWORD"
       }
       if ($value !~ /^$/) {
           $value = " VALUE=\"".$value."\"";
       }
     -]
     <TR>
         <TD VALIGN="top" ALIGN="right"><B>[+ $title +]:&nbsp;</B></TD>
	 <TD><INPUT TYPE="[+ $type +]" NAME="[+ $name +]"[+ $size.$maxlength.$value +]>[- hint_text($hint_text) -]</TD>
     </TR>
[$ endsub $]

[$ sub form_element_radio $]
    [- $title = shift;
       $name = shift;
       $value = shift;
       if (($check_flag = shift) > 0) {
           $check_flag = " CHECKED";
       }
    -]
    [$ if ($title) $]
        [+ $title +] 
    [$ endif $]
    <INPUT TYPE="radio" NAME="[+ $name +]" VALUE="[+ $value +]"[+ $check_flag +]>

[$ endsub$]

[$ sub systems_form $]
    [- $system = shift; -]
    <TR><TD VALIGN="TOP" ALIGN="RIGHT"><B>System(s):</B></TD>
    <TD><TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Cardiovascular" NAME="system" [+ 'CHECKED' if($system =~ m/Cardiovascular/) +]>Cardiovascular</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Digestive" NAME="system" [+ 'CHECKED' if($sytem =~ m/Digestive/) +]>Digestive</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Endocrine" NAME="system" [+ 'CHECKED' if($system =~ m/Endocrine/) +]>Endocrine</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Hemic" NAME="system">Hemic</TD></TR>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Immune" NAME="system">Immune</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Musculoskeletal" NAME="system" [+ 'CHECKED' if($system =~ m/Musculoskeletal/) +]>Musculoskeletal</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Nervous" NAME="system" [+ 'CHECKED' if ($system =~ m/Nervous/) +]>Nervous</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Reproductive" NAME="system" [+ 'CHECKED' if($system =~ m/Reproductive/) +]>Reproductive</TD></TR>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Respiratory" NAME="system" [+ 'CHECKED' if($system =~ m/Respiratory/) +]>Respiratory</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Sense Organs" NAME="system" [+ 'CHECKED' if($system =~ m/Sense Organs/) +]>Sense Organs</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Skin" NAME="system" [+ 'CHECKED' if($system =~ m/Skin/) +]>Skin</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Urinary Tract" NAME="system" [+ 'CHECKED' if($system =~ m/Urinary Tract/) +]>Urinary Tract</TD></TR></TABLE>
    </TD></TR>
[$ endsub $]

[$ sub content_systems_form $]
    [- $content = shift; -]
	[- delete $fdat{'system'} -]
    <TR><TD VALIGN="TOP" ALIGN="RIGHT"><B>System(s):</B></TD>
    <TD><TABLE BORDER=0 CELLPADDING=1 CELLSPACING=0>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Cardiovascular" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Cardiovascular/) +]>Cardiovascular</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Digestive" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Digestive/) +]>Digestive</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Endocrine" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Endocrine/) +]>Endocrine</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Hemic" NAME="system" [+ 'CHECKED' if (($content->field_value('system')) =~ /Hemic/) +]>Hemic</TD></TR>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Immune" NAME="system">Immune</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Musculoskeletal" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Musculoskeletal/) +]>Musculoskeletal</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Nervous" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Nervous/) +]>Nervous</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Reproductive" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Reproductive/) +]>Reproductive</TD></TR>
    <TR><TD><INPUT TYPE="CHECKBOX" VALUE="Respiratory" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Respiratory/) +]>Respiratory</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Sense Organs" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Sense Organs/) +]>Sense Organs</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Skin" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Skin/) +]>Skin</TD>
    <TD><INPUT TYPE="CHECKBOX" VALUE="Urinary Tract" NAME="system" [+ 'CHECKED' if(($content->field_value('system')) =~ /Urinary Tract/) +]>Urinary Tract</TD></TR></TABLE>
    </TD></TR>
[$ endsub $]

[$ sub action_message $]
    [- $status_message = shift;
       $course_id = shift;
       $content_id = shift;
       $ln_content_id = shift;
    -]
    [$ if ($course_id) $]
            <B>[+ $status_message +]</B><BR>
            [$ if ($content_id) $]
		[- $url = "/hsdb4/content" -]
		[$ if ($ln_content_id) $]
	            [- $url .= "/$ln_content_id" -]
	        [$ endif$]
	    [- $url .= "/$content_id" -]
	    <B>You can view this item at:</B><BR>&nbsp;&nbsp;&nbsp;<A HREF="[+ $url +]">[+ $url +]</A><BR>
            [$ endif $]
    [$ endif $]
[$ endsub $]

[$ sub out_sort_order $]
    [-  $course = shift;
        $content_id = shift;
        my $include_content; -]
    [-
        $ref = "";
	# if this is an addition to the course collection get the contents
	if ($content_id) {
		$ref = HSDB4::SQLRow::Content->new->lookup_key($fdat{'content_id'});
		@content = $ref->child_content;
	}
	# otherwise if this is an addition to an existing collection get the contents
	else {
	        ($school,$course_id) = split("-",$course);
		$ref = HSDB45::Course->new(_school => $school, _id => $course_id);
		@content = $ref->child_content;
	}
    -]
    <TR><TD colspan="2"><h4 class="title">Sort order for [+ $ref->out_label +]</h4></TD></TR>
	<INPUT TYPE="hidden" NAME="content_id" VALUE="[+ $content_id +]">
	[$ if (@content) $]
	    <TR><TD ALIGH=RIGHT>&nbsp;</TD><TD ALIGN=LEFT>
	    <TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0">
	    <TR><TD><B>Sort Order&nbsp;&nbsp;&nbsp;&nbsp;</B></TD><TD><B>Title&nbsp;&nbsp;&nbsp;&nbsp;</B></TD><TD><B>Type</B></TD></TR>
	    [$ foreach $item (@content) $]
	        <TR><TD>[+ $item->aux_info('sort_order') +]&nbsp;&nbsp;&nbsp;&nbsp;</TD>	
		<TD>[+ $item->field_value('title') +]&nbsp;&nbsp;&nbsp;&nbsp;</TD>
		<TD>[+ $item->out_icon +]</TD></TR>    	        
	    [$ endforeach $]
	    </TABLE>
	    </TD></TR>
	[$ endif $]
[$ endsub $]

[$ sub get_CGI_time $]
    [# get the current time and put it in HTTP Header format #]
    [# Mon, 14 May 2001 13:09:57 GMT #]
    [- @tm = (localtime);
       $day_name = (Sun,Mon,Tue,Wed,Thu,Fri,Sat)[$tm[6]];
       $month_name = (Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec)[$tm[4]];
       $tm[0] = "0".$tm[0] if $tm[0] !~ /\d{2}/;
       $tm[1] = "0".$tm[1] if $tm[1] !~ /\d{2}/;
       $tm[2] = "0".$tm[2] if $tm[2] !~ /\d{2}/;
       $output = $day_name.", ".$tm[3]." ".$month_name." ".($tm[5]+1900)." ".$tm[2].":".$tm[1].":".$tm[0];
     -]
    [+ $output +]
[$ endsub $]

[$ sub course_admin $]
    [- $course = shift;
    $role = shift; 
    -]
    <h3 CLASS="title">Administrative Tools</H3>
    Edit Course Info
    [+ +]
[$ endsub $]

[$ sub out_course_dropdown $]
   [- $user = shift;
      @courses = @_;
      if (!@courses) {
         @courses = $user->parent_courses;
	 push (@courses,$user->admin_courses);
      }
   $course_list = "";
   -]
   <SELECT NAME="course">
   <option>-- Select Course--</option>
exit
   [$ foreach $course (sort {lc($a->out_label) cmp lc($b->out_label)} @courses) $]
       [-  $selected = "";
           $course_id = $course->field_value("course_id");
	   $school = $course->school;
	   $label = $course->out_label;
	   $label = substr($label,0,30)."..." if (length($label) > 30); 
       -]
       [$ if ($course_list !~ /\!$course_id$school\!/) $]
       [-
	   $course_list .= "!".$course_id.$school."!";
           if ($user->preference('image_upload_course_id') eq $course->primary_key) {
	       $selected = 'SELECTED';
	   }
       -]       
       <option value="[+ $school +]-[+ $course_id +]">[+ $label +] - [+ $school +] - [+ $course_id +]</option>
       [$ endif $]
   [$ endforeach $]
   </SELECT>
[$ endsub $]

[$ sub pop_up $]
    [- $url = shift; $text = shift; -]
     <a href="javascript:" onClick="javascript:window.open('[+ $url +]', 'xxx', 'WIDTH=600,HEIGHT=600,toolbar=yes,location=no,scrollbars=yes,menubar=no,resizable=yes');">[+ $text+]</a>
[$ endsub $]

[$ sub date_to_html_edit $]
[- 
$date = shift; 
$prefix = shift; 

@mmap = qw/Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec/;
if ($date =~ /^(\d{4})-(\d{2})-(\d{2})$/){
	$y = $1;
	$m = $2;
	$d = $3;
} else {
	($d, $m, $y) = (localtime(time))[3,4,5];
	$y += 1900;
	$m += 1;
}
$mm = $mmap[$m+1];
-]
<select name="[+$prefix+]-month">
[$ foreach $mmm (1 .. 12) $]
	<option value="[+$mmm+]"[+ $mmm == $m ? ' selected' : ''+]>[+$mmap[$mmm-1]+]
[$ endforeach $]
</select>

<select name="[+$prefix+]-day">
[$ foreach $dd (1 .. 31) $]
	<option value="[+$dd+]"[+ $dd == $d ? ' selected' : ''+]>[+$dd+]
[$ endforeach $]
</select>

<select name="[+$prefix+]-year">
[$ foreach $yy ($y-2 .. $y+2) $]
	<option[+ $yy == $y ? ' selected ' : ''+]>[+$yy+]
[$ endforeach $]
</select>
[$ endsub $]

[$ sub chooser_link $]
	[- $type = shift; 
	$pform = shift; 
	$field = shift; 
	$text = shift;
	
	$fname = sprintf('open_%s_chooser', $type); 
	-]
<script language="JavaScript">
<!--
function [+$fname+] (type, pform, field){
	param = "directories=no,menubar=no,toolbar=yes,scrollbars=yes,resizable=yes,width=" + 600 + ",height=" + 450;
	current_selection = eval ("document." + pform + "." + field + ".value");
	[$ if ($type =~ /user_content/) $]
		chooser_window = window.open("/cms/user-content-chooser?parent-form=" + pform + "&fill-field=" + field + "&current_selection=" + current_selection, type +"chooser", param);
	[$ else $]
		chooser_window = window.open("/cms/chooser?type=" + type + "&parent-form=" + pform + "&fill-field=" + field + "&current_selection=" + current_selection, type +"chooser", param);
	[$ endif $]
	if (!chooser_window.opener) chooser_window.opener = self;
}
//-->
</script>
	<a class="chooser" href="" onClick="[+$fname+]('[+$type+]','[+$pform+]','[+$field+]'); return false;">[+$text+]</a>
[$ endsub $]

[$ sub output $]
[$ foreach $line (@_) $]
  [+ $line +]
[$ endforeach $]
[$ endsub $]
[$ sub chicklet $]
    <div class="chicklet">
    [$ while ($name = shift) $]
      [- undef $target -]
      [$ if ($name =~ /preview/) $]
          [- $target=" target=\"_blank\"" -]
      [$ endif $]
      [- $url = shift; -]
      [<a class="chicklet" href="[+ $url+]"[+ $target +]>[+ $name +]</a>]
    [$ endwhile $]
    </div>
[$ endsub $]

[$ sub nav_links $]
    <div class="nav">
    [$ while ($url = shift) $]
    [- $name = shift -]
    [<a class="nav" href="[+ $url +]">[+ $name +]</a>]
    [$ endwhile $]
    </div>
[$ endsub $]

[$ sub remove_head $]
    [- $text = shift; -]
    [- $text =~ s/\<\?.+\/h3\>(.+)/$1/s; -]
    [+ $text; +]
[$ endsub $]

[$ sub bar $]
<div class="bar"><table cellpadding=0 cellspacing=0 width=100%><tr><td class="bar"><img src="/icons/transdot.gif" width=1 height=2></td></tr></table></div>
[$ endsub $]

[$ sub db_prompt $]
[- $user_id = shift; -]
<table>
<tr><td>Username:</td><td><tt>[+ $user_id +]</tt></td></tr>
<tr><td>Password:</td><td><input type="password" name="password" size="15"> <input type="submit" value="Save"></td></tr>
</table>
[$ endsub $]

[$ sub error_message $]
[- $msg = shift -]
[$ if ($msg) $]
   <table><tr><td class="error_message">
      <div class="error_message">[+ $msg +]</div>
      </td></tr>
   </table>
[$ endif $]
[$ endsub $]

[$ sub success_message $]
[- $msg = shift -]
[$ if ($msg) $]
   <table cellpadding="0" cellspacing="0" border="0">
   <tr><td class="error_message">
      <div class="success_message">&nbsp;[+ $msg +]&nbsp;</div>
      </td></tr>
   </table>

[$ endif $]
[$ endsub $]

[$ sub hscml_key $]
<div class="hscml_key">
<span class="nugget">&nbsp;nugget&nbsp;</span>
<span class="keyword">&nbsp;keyword&nbsp;</span>
<span class="objective-item">&nbsp;objective&nbsp;</span>
<span class="topic-sentence">&nbsp;topic-sentence&nbsp;</span>
<span class="summary">&nbsp;summary&nbsp;</span>
<span class="warning">&nbsp;warning&nbsp;</span>
</div>
[$ endsub $]


[$ sub security_notice_start $]
[- 
    ($user_fullname, $link_url, $link_text) = @_; 

    if ($link_url){
	$js_code = "location.href='" . $link_url . "'";
    }else{
	$js_code = "return close_notice();";
    }
    $link_text = "Continue" unless ($link_text);
-]
<script>
function close_notice(){
	document.getElementById('notice_securitynotice').style.display="none";
	document.getElementById('notice_content').style.display="block";
	return false;
}
</script>
<div id="notice_maincontent">
<form style="padding: 0;margin: 0px;">
<div id ="notice_securitynotice" class="medium">
<h3>Important Privacy Notice</h3>
You are currently logged in as <b>[+ $user_fullname +]</b>.  This section of [+ $TUSK::Constants::SiteAbbr +] contains private information.  If you are not <b>[+ $user_fullname +]</b> please log out.<br><br>
[+ $TUSK::Constants::privacy_notice +]<br><br>
<div align="center">
<table id="notice_choices" cellspacing="7">
	<tr>
		<td><b>Yes</b>, I am <b>[+ $user_fullname +]</b>.  I understand that I <b>MUST</b> logout prior to leaving this computer.
		</td>
		<td valign="middle" align="center" nowrap>
			<input type="button" value="[+ $link_text +]" onclick="[+ $js_code +]" class="formbutton">
		</td>
	</tr>
	<tr>
		<td colspan="2">&nbsp;</td>
	</tr>
	<tr>
		<td><b>No</b>, I am <b>NOT</b> <b>[+ $user_fullname +]</b>, I need to logout.</td>
		<td valign="middle" align="center"><input type="button" value="Logout" onclick="location.href='/dologout'" class="formbutton">
	</tr>
</table>
<br><br>		
</div>
</div>
<div id="notice_content">

[$ endsub $]

[$ sub security_notice_end $]
</div>
</div>
[$ endsub $]
