[! use HSDB4::SQLRow::User;
   use HSDB4::SQLRow::PersonalContent;
   use TUSK::Constants;
   use TUSK::Session;
!]

[- 
   ## doc is a content object which overrides the default style
   $doc = shift @param;
   $user = shift @param;
   unless ($user){
	   $user = HSDB4::SQLRow::User->new();
	   $user_id = $req_rec->connection->user();
	   $shib_user_id = $req_rec->connection->user();
	   unless (HSDB4::Constants::is_guest ($user_id) || (TUSK::ShibbolethUser->isShibUser($shib_user_id) == -1)) {
	     $user->lookup_key ($user_id);
	   }
   }
   $ssrv = $req_rec->dir_config('SecureLogin') || 'https://' . $TUSK::Constants::Domain . '/login';
  $time = HSDB4::DateTime->new()->out_unix_time; 
-]

<table width="100%" class="userbox" border="0" cellpadding="2" cellspacing="0">

<tr><td width="33%" valign="top" align="left"> 
[$ if ($doc) $]
    [$ if ($doc->field_value('style') =~ /Liver/) $]
        [- $home = "http://liver.med.tufts.edu/" -]
    [$ else $]
        [- $home = "/home?$time" -]
    [$ endif $]
    <a href="[+ $home +]"><img src="/icons/little/al[+ $doc->field_value('style') +].gif" border="0" hspace="6" align="left" vspace="0" width="66" height="50" /></a>
[$ else $]
    <a href="/home?[+ $time +]"><img src="/icons/little/alhome.gif" border="0" hspace="0" align="left" vspace="0" width="40" height="40" /></A>
[$ endif $]
    <div class="userbox-head"><a href="/home?[+ $time+]">[+ $TUSK::Constants::SiteAbbr +] Home</a>&nbsp;[$ if (TUSK::Session::is_author(\%udat, $user)) $][<a href="/protected/manage">Manage Content</a>][$ endif $]</div>
[$ if(TUSK::Constants::HelpURL) $]<div class="userbox"><a href="[+ $TUSK::Constants::HelpURL +]">Get Help</a></div>[$ endif $]
[$ if ($doc) $]
    [$ if ($doc->field_value('style') =~ /Liver/) $]
        [- $search = "/search/form?Search=1&content_id=".$doc->primary_key;
	   $search_text = "Search" -]
    [$ else $]
	[- $search = "/search/form";
	   $search_text = "Search ".$TUSK::Constants::SiteAbbr -]
    [$ endif $]
    <div class="userbox"><a href="[+ $search +]">[+ $search_text +]</a></div>
[$ else $]
    <div class="userbox"><a href="/search/form">Search [+ $TUSK::Constants::SiteAbbr +]</a></div>
[$ endif $]

</td>

[$ if $user->primary_key $]
<td width="34%" valign="top" align="center">
   <!-- User Personal Info-->
   <div class="userbox-head">[+$user->out_short_name+]</div>
   <div class="userbox">
     <a class="logout" href="/dologout">Logout</a></div>
   <div class="userbox">
   </div>
</td>

<form method="post" action="/management/content/personalcontent" class="userbox">
<td width="33%" valign="top"><div class="userbox-head"><a href="/management/content/personalcontent">Personal Folders</a></div>
   [$ if $req_rec->uri =~ m!/hsdb4/content! $]
   [- @folders = $user->child_personal_content;
      @folders = grep { $_->field_value('type') eq 'Collection' } @folders;
      push @folders, 0;
    -]
   <div class="userbox">
   <select name="add_to_folder" class="userbox">
   [$ foreach $per_folder @folders $]
   [$ if $per_folder $]
   <option value="[+$per_folder->primary_key()+]">[+$per_folder->out_abbrev()+]</option>
   [$ else $]
   <option value="-1">New Folder</option>
   [$ endif $]
   [$ endforeach $]
   </select>
   <input type="submit" value="Add" />
   <input type="hidden" name="content_item" value="[+$req_rec->path_info+]" />
   </div>
   [$ else $]
   &nbsp;
   [$ endif $]
</td>
</form>

[$ else $]
<form method="post" action="[+ $ssrv +]">
<td width="34%" valign="center">
      [# Find out if there's a login error, and print it if there it #]
      [$ if ($msg = $req_rec->err_headers_out->{'X-Login-Error'}) $]
      <div class="userbox"><b>Could not log in:</b> [+$msg+]>/div>
      [$ endif $]
      <div class="userbox">User name:</div>
      <div class="userbox">
        <input type="text" name="user" SIZE=15 VALUE="" />
      </div>
</td>

<td width="33%" valign="center">
   <div class="userbox">Password:</div>
   <div class="userbox"><input type="password" name="password" SIZE=15 VALUE="" />
   <input type="Submit" value="Log In" /></div>
   <input type="hidden" name="request_uri" value="[+$req_rec->uri+]" />
</td>
</form>
[$ endif $]
</tr>
</table>

